{% extends "base.html" %}

{% block title %}故障诊断推理{% endblock %}

{% block content %}
<style>
    /* 页面整体样式 */
    .inference-page {
        min-height: 100vh;
        padding: 2rem 0;
    }

    /* 页面标题区域 */
    .page-header {
        background: transparent;
        color: #495057;
        padding: 1rem 0 2rem;
        margin-bottom: 1rem;
        border: none;
        box-shadow: none;
        text-align: center;
    }

    .page-header h2 {
        font-weight: 700;
        margin-bottom: 0.5rem;
        color: #D84343;
    }

    .page-header p {
        opacity: 0.8;
        margin-bottom: 0;
        color: #6c757d;
    }

    /* 卡片样式增强 */
    .inference-card {
        border: none;
        border-radius: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        overflow: hidden;
    }

    .inference-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    .inference-card .card-header {
        background: #f8f9fa;
        color: #495057;
        border: none;
        padding: 1.25rem 1.5rem;
        font-weight: 600;
    }

    .inference-card .card-body {
        padding: 2rem;
    }

    /* 统计卡片样式 */
    .stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: #D84343;
    }

    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        border-color: #D84343;
    }

    .stat-card h4 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-card.primary h4 { color: #D84343; }
    .stat-card.danger h4 { color: #dc3545; }
    .stat-card.warning h4 { color: #ffc107; }
    .stat-card.info h4 { color: #17a2b8; }

    /* 表单样式 */
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.75rem;
    }

    .form-control, .form-select {
        border-radius: 0.5rem;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: #D84343;
        box-shadow: 0 0 0 0.2rem rgba(216, 67, 67, 0.25);
    }

    /* 按钮样式 */
    .btn-fd-primary {
        background: linear-gradient(135deg, #FF8A8A, #D84343);
        border: none;
        border-radius: 0.5rem;
        padding: 0.75rem 2rem;
        font-weight: 600;
        color: white;
        transition: all 0.3s ease;
    }

    .btn-fd-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(216, 67, 67, 0.3);
        color: white;
        background: linear-gradient(135deg, #D84343, #C0392B);
    }

    /* 模型信息卡片 */
    .model-info-card {
        background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .model-info-card h6 {
        color: #B71C1C;
        margin-bottom: 1rem;
    }

    /* 结果区域样式 */
    .results-section {
        animation: fadeInUp 0.5s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* 分类结果卡片 */
    .classification-result {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
        text-align: center;
    }

    .classification-result .predicted-label {
        font-size: 2.5rem;
        font-weight: 700;
        color: #D84343;
        margin-bottom: 0.5rem;
    }

    .classification-result .confidence {
        font-size: 1.25rem;
        color: #6c757d;
    }

    /* 图表容器 */
    .chart-container {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }

    /* 加载动画 */
    .loading-spinner {
        display: inline-block;
        width: 1rem;
        height: 1rem;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 标签徽章 */
    .label-badge {
        display: inline-block;
        padding: 0.5rem 1rem;
        border-radius: 2rem;
        font-weight: 600;
        margin: 0.25rem;
    }

    .label-badge.active {
        background: #D84343;
        color: white;
    }

    .label-badge.inactive {
        background: #e9ecef;
        color: #6c757d;
    }

    /* 条件信息 */
    .condition-info {
        background: #fff3cd;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        margin-top: 1rem;
    }
    
    /* Custom text colors */
    .text-primary-custom {
        color: #D84343 !important;
    }
    
    .bg-primary-custom {
        background-color: #D84343 !important;
        color: white;
    }
    
    .btn-outline-primary-custom {
        color: #D84343;
        border-color: #D84343;
    }
    
    .btn-outline-primary-custom:hover {
        background-color: #D84343;
        color: white;
        border-color: #D84343;
    }
</style>

<div class="inference-page">
    <div class="container">
        <!-- 页面标题 -->
        <div class="page-header">
            <h2 class="mb-2">
                <i class="fas fa-search me-2"></i>故障诊断推理
            </h2>
            <p class="mb-4">选择训练好的模型和数据文件，进行故障类型诊断</p>
        </div>

        <!-- 推理配置表单 -->
        <div class="inference-card card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>推理配置
                </h5>
            </div>
            <div class="card-body">
                <form id="inferenceForm">
                    <div class="row g-4">
                        <!-- 模型选择 -->
                        <div class="col-md-6">
                            <label class="form-label" for="modelSelect">
                                <i class="fas fa-brain me-2"></i>选择模型
                                <span class="text-danger">*</span>
                            </label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="modelSelect" name="model_id" required>
                                    <option value="">请选择模型...</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary-custom" id="refreshModelsBtn" title="刷新模型列表">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="form-text">从 edge/models/fault_diagnosis 选择训练好的模型</div>
                        </div>

                        <!-- 数据文件选择 -->
                        <div class="col-md-6">
                            <label class="form-label" for="dataFileSelect">
                                <i class="fas fa-file-csv me-2"></i>数据文件
                                <span class="text-danger">*</span>
                            </label>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="dataFileSelect" name="data_file" required>
                                    <option value="">请选择数据文件...</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary-custom" id="refreshDataFilesBtn" title="刷新文件列表">
                                    <i class="fas fa-sync"></i>
                                </button>
                            </div>
                            <div class="form-text">从 edge/data/processed/FaultDiagnosis 选择预处理后的数据</div>
                        </div>

                        <!-- 模型信息显示 -->
                        <div class="col-12" id="modelInfoContainer" style="display: none;">
                            <div class="model-info-card">
                                <h6><i class="fas fa-info-circle me-2"></i>模型配置信息</h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">序列长度</small>
                                        <div class="fw-bold" id="infoSequenceLength">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">特征维度</small>
                                        <div class="fw-bold" id="infoFeatures">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">类别数</small>
                                        <div class="fw-bold" id="infoNumClasses">-</div>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">模型类型</small>
                                        <div class="fw-bold" id="infoModelType">-</div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">分类标签</small>
                                    <div id="infoLabels" class="mt-1"></div>
                                </div>
                                <div id="infoConditions" class="condition-info mt-3" style="display: none;">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-cog me-1"></i>工况信息</small>
                                    <div id="infoConditionsList"></div>
                                </div>
                                <div class="alert alert-warning mt-3 mb-0" id="dataCompatibilityWarning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <span id="compatibilityMessage"></span>
                                </div>
                            </div>
                        </div>

                        <!-- 工况值输入（根据模型配置动态生成） -->
                        <div class="col-12" id="conditionInputContainer" style="display: none;">
                            <div class="card border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-sliders-h me-2"></i>工况设置
                                        <span class="text-danger">*</span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle me-2"></i>
                                        该模型训练时使用了工况特征，推理时需要指定当前数据对应的工况值。工况值将作为特征维度添加到数据中。
                                    </div>
                                    <div class="row g-3" id="conditionInputsArea">
                                        <!-- 动态生成的工况输入框 -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 批处理大小 -->
                        <div class="col-md-6">
                            <label class="form-label" for="batchSize">
                                <i class="fas fa-layer-group me-2"></i>批处理大小
                            </label>
                            <input type="number" class="form-control" id="batchSize" 
                                   name="batch_size" value="32" min="1" max="512">
                            <div class="form-text">推理时的批处理大小</div>
                        </div>

                        <!-- 操作按钮 -->
                        <div class="col-12">
                            <div class="d-flex gap-3 justify-content-center">
                                <button type="submit" class="btn btn-fd-primary btn-lg" id="runInferenceBtn">
                                    <i class="fas fa-play me-2"></i>开始诊断
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="resetForm()">
                                    <i class="fas fa-undo me-2"></i>重置表单
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 推理结果显示区域 -->
        <div id="resultsSection" style="display: none;" class="results-section">
            <div class="inference-card card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>诊断结果
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-light" id="downloadResultBtn">
                            <i class="fas fa-download me-1"></i>下载结果
                        </button>
                        <button class="btn btn-sm btn-light" onclick="hideResults()">
                            <i class="fas fa-times me-1"></i>隐藏
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- 主要诊断结果 -->
                    <div class="classification-result">
                        <div class="predicted-label" id="predictedLabel">-</div>
                        <div class="confidence">置信度: <span id="confidenceValue">-</span></div>
                    </div>

                    <!-- 结果统计 -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-3">
                            <div class="stat-card success">
                                <h4 id="totalSamples">-</h4>
                                <small class="text-muted">
                                    <i class="fas fa-database me-1"></i>总样本数
                                </small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card info">
                                <h4 id="correctPredictions">-</h4>
                                <small class="text-muted">
                                    <i class="fas fa-check-circle me-1"></i>主类样本
                                </small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card warning">
                                <h4 id="avgConfidence">-</h4>
                                <small class="text-muted">
                                    <i class="fas fa-percentage me-1"></i>平均置信度
                                </small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card danger">
                                <h4 id="inferenceTime">-</h4>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>推理耗时
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- 各类别预测分布图 -->
                    <div class="chart-container">
                        <h6 class="mb-3">
                            <i class="fas fa-chart-pie me-2 text-primary-custom"></i>类别预测分布
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div style="height: 300px; position: relative;">
                                    <canvas id="classDistributionChart"></canvas>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div id="classDistributionTable"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 置信度分布图 -->
                    <div class="chart-container">
                        <h6 class="mb-3">
                            <i class="fas fa-chart-bar me-2 text-primary-custom"></i>置信度分布
                        </h6>
                        <div style="height: 250px; position: relative;">
                            <canvas id="confidenceDistChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-4 mb-2">
            <a href="/fault_diagnosis" class="btn btn-outline-primary-custom btn-lg px-5 py-3">
                <i class="fas fa-arrow-left me-2"></i>返回故障诊断主页
            </a>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// 全局变量
let currentModelConfig = null;
let currentResult = null;
let classDistChart = null;
let confidenceChart = null;

// 页面加载完成后初始化
document.addEventListener('DOMContentLoaded', function() {
    loadAvailableModels();
    loadAvailableDataFiles();
    bindEvents();
    
    // 检查URL参数是否有预选模型
    const urlParams = new URLSearchParams(window.location.search);
    const preselectedModel = urlParams.get('model');
    if (preselectedModel) {
        setTimeout(() => {
            const modelSelect = document.getElementById('modelSelect');
            if (modelSelect) {
                modelSelect.value = preselectedModel;
                onModelSelect(preselectedModel);
            }
        }, 500);
    }
});

function bindEvents() {
    // 表单提交
    document.getElementById('inferenceForm').addEventListener('submit', (e) => {
        e.preventDefault();
        runInference();
    });

    // 刷新模型列表
    document.getElementById('refreshModelsBtn').addEventListener('click', loadAvailableModels);

    // 刷新数据文件列表
    document.getElementById('refreshDataFilesBtn').addEventListener('click', loadAvailableDataFiles);

    // 模型选择变化
    document.getElementById('modelSelect').addEventListener('change', (e) => {
        onModelSelect(e.target.value);
    });

    // 下载结果
    document.getElementById('downloadResultBtn').addEventListener('click', downloadResult);
}

// 加载可用模型列表
async function loadAvailableModels() {
    const btn = document.getElementById('refreshModelsBtn');
    const select = document.getElementById('modelSelect');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/fault_diagnosis/api/models');
        const result = await response.json();
        
        if (result.success) {
            populateModelSelect(result.models);
            showMessage('模型列表已更新', 'success');
        } else {
            throw new Error(result.error || '获取模型列表失败');
        }
    } catch (error) {
        console.error('加载模型失败:', error);
        showMessage(`加载模型失败: ${error.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i>';
    }
}

function populateModelSelect(models) {
    const select = document.getElementById('modelSelect');
    select.innerHTML = '<option value="">请选择模型...</option>';
    
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.task_id;
        const modelType = model.model_type || model.config?.model_type || '未知';
        const seqLen = model.config?.sequence_length || '?';
        option.textContent = `${model.task_id} (${formatModelType(modelType)}, 序列${seqLen})`;
        option.dataset.config = JSON.stringify(model.config || {});
        select.appendChild(option);
    });
}

function formatModelType(modelType) {
    const typeMap = {
        'cnn_1d_classifier': 'CNN 1D',
        'cnn_1d': 'CNN 1D',
        'lstm_classifier': 'LSTM',
        'lstm': 'LSTM',
        'resnet_1d_classifier': 'ResNet 1D',
        'resnet_1d': 'ResNet 1D'
    };
    return typeMap[modelType] || modelType;
}

// 加载可用数据文件列表
async function loadAvailableDataFiles() {
    const btn = document.getElementById('refreshDataFilesBtn');
    const select = document.getElementById('dataFileSelect');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    
    try {
        const response = await fetch('/fault_diagnosis/api/inference/data_files');
        const result = await response.json();
        
        if (result.success) {
            populateDataFileSelect(result.files);
            showMessage('数据文件列表已更新', 'success');
        } else {
            throw new Error(result.error || '获取数据文件列表失败');
        }
    } catch (error) {
        console.error('加载数据文件失败:', error);
        showMessage(`加载数据文件失败: ${error.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-sync"></i>';
    }
}

function populateDataFileSelect(files) {
    const select = document.getElementById('dataFileSelect');
    select.innerHTML = '<option value="">请选择数据文件...</option>';
    
    files.forEach(file => {
        const option = document.createElement('option');
        option.value = file.path;
        option.textContent = `${file.name} (${formatFileSize(file.size)})`;
        option.dataset.info = JSON.stringify(file);
        select.appendChild(option);
    });
}

function formatFileSize(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// 模型选择变化处理
function onModelSelect(modelId) {
    const select = document.getElementById('modelSelect');
    const option = select.querySelector(`option[value="${modelId}"]`);
    const infoContainer = document.getElementById('modelInfoContainer');
    
    if (!modelId || !option) {
        infoContainer.style.display = 'none';
        currentModelConfig = null;
        return;
    }
    
    try {
        const config = JSON.parse(option.dataset.config || '{}');
        currentModelConfig = config;
        
        // 显示模型信息
        infoContainer.style.display = 'block';
        document.getElementById('infoSequenceLength').textContent = config.sequence_length || '-';
        document.getElementById('infoFeatures').textContent = config.n_features || '-';
        document.getElementById('infoNumClasses').textContent = config.num_classes || '-';
        document.getElementById('infoModelType').textContent = formatModelType(config.model_type || '-');
        
        // 显示标签
        const labelsContainer = document.getElementById('infoLabels');
        if (config.labels && config.labels.length > 0) {
            labelsContainer.innerHTML = config.labels.map((label, idx) => 
                `<span class="label-badge inactive">${idx}: ${label}</span>`
            ).join('');
        } else {
            labelsContainer.innerHTML = '<span class="text-muted">未知</span>';
        }
        
        // 显示工况信息和生成工况输入框
        const conditionsContainer = document.getElementById('infoConditions');
        const conditionsList = document.getElementById('infoConditionsList');
        const conditionInputContainer = document.getElementById('conditionInputContainer');
        const conditionInputsArea = document.getElementById('conditionInputsArea');
        
        if (config.conditions && config.conditions.length > 0) {
            conditionsContainer.style.display = 'block';
            conditionsList.innerHTML = config.conditions.map(c => 
                `<span class="badge bg-warning text-dark me-2">${c.name}: ${c.values.join(', ')}</span>`
            ).join('');
            
            // 生成工况输入框
            conditionInputContainer.style.display = 'block';
            conditionInputsArea.innerHTML = config.conditions.map((c, idx) => `
                <div class="col-md-4">
                    <label class="form-label">${c.name} <span class="text-danger">*</span></label>
                    <select class="form-select condition-value-select" 
                            id="conditionValue_${idx}" 
                            data-condition-name="${c.name}"
                            required>
                        <option value="">请选择${c.name}...</option>
                        ${c.values.map(v => `<option value="${v}">${v}</option>`).join('')}
                    </select>
                    <div class="form-text">训练时使用的${c.name}值: ${c.values.join(', ')}</div>
                </div>
            `).join('');
        } else {
            conditionsContainer.style.display = 'none';
            conditionInputContainer.style.display = 'none';
            conditionInputsArea.innerHTML = '';
        }
        
        showMessage(`已选择模型: ${modelId}`, 'info');
        
    } catch (e) {
        console.error('解析模型配置失败:', e);
        infoContainer.style.display = 'none';
    }
}

// 执行推理
async function runInference() {
    const btn = document.getElementById('runInferenceBtn');
    const modelId = document.getElementById('modelSelect').value;
    const dataFile = document.getElementById('dataFileSelect').value;
    const batchSize = document.getElementById('batchSize').value;
    
    // 验证
    if (!modelId) {
        showMessage('请选择一个模型', 'warning');
        return;
    }
    if (!dataFile) {
        showMessage('请选择一个数据文件', 'warning');
        return;
    }
    
    // 收集工况值
    const conditionValues = {};
    const conditionSelects = document.querySelectorAll('.condition-value-select');
    for (const select of conditionSelects) {
        const conditionName = select.dataset.conditionName;
        const value = select.value;
        if (!value) {
            showMessage(`请选择${conditionName}的值`, 'warning');
            return;
        }
        conditionValues[conditionName] = parseFloat(value);
    }
    
    // 更新按钮状态
    btn.disabled = true;
    btn.innerHTML = '<span class="loading-spinner me-2"></span>诊断中...';
    
    try {
        showMessage('正在执行故障诊断推理，请稍候...', 'info');
        
        const response = await fetch('/fault_diagnosis/api/inference/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_id: modelId,
                data_file: dataFile,
                batch_size: parseInt(batchSize) || 32,
                condition_values: conditionValues  // 传递工况值
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentResult = result.result;
            displayResults(result.result);
            showMessage('诊断完成！', 'success');
        } else {
            throw new Error(result.error || '推理失败');
        }
        
    } catch (error) {
        console.error('推理失败:', error);
        showMessage(`推理失败: ${error.message}`, 'danger');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-play me-2"></i>开始诊断';
    }
}

// 显示推理结果
function displayResults(result) {
    document.getElementById('resultsSection').style.display = 'block';
    
    // 主要诊断结果
    document.getElementById('predictedLabel').textContent = result.predicted_label || '-';
    document.getElementById('confidenceValue').textContent = 
        result.confidence ? (result.confidence * 100).toFixed(2) + '%' : '-';
    
    // 统计数据
    document.getElementById('totalSamples').textContent = result.total_samples || '-';
    document.getElementById('correctPredictions').textContent = 
        result.class_distribution ? result.class_distribution[result.predicted_label] || '-' : '-';
    document.getElementById('avgConfidence').textContent = 
        result.avg_confidence ? (result.avg_confidence * 100).toFixed(2) + '%' : '-';
    document.getElementById('inferenceTime').textContent = 
        result.inference_time ? result.inference_time.toFixed(3) + 's' : '-';
    
    // 绘制类别分布图
    drawClassDistributionChart(result);
    
    // 绘制置信度分布图
    drawConfidenceDistChart(result);
    
    // 滚动到结果区域
    document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

// 绘制类别分布图
function drawClassDistributionChart(result) {
    const ctx = document.getElementById('classDistributionChart').getContext('2d');
    
    if (classDistChart) {
        classDistChart.destroy();
    }
    
    const distribution = result.class_distribution || {};
    const labels = Object.keys(distribution);
    const data = Object.values(distribution);
    
    // 生成颜色
    const colors = generateColors(labels.length);
    
    classDistChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
    
    // 生成表格
    const tableContainer = document.getElementById('classDistributionTable');
    const total = data.reduce((a, b) => a + b, 0);
    tableContainer.innerHTML = `
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>类别</th>
                    <th>样本数</th>
                    <th>占比</th>
                </tr>
            </thead>
            <tbody>
                ${labels.map((label, idx) => `
                    <tr>
                        <td>
                            <span class="badge" style="background-color: ${colors[idx]}">&nbsp;</span>
                            ${label}
                        </td>
                        <td>${distribution[label]}</td>
                        <td>${(distribution[label] / total * 100).toFixed(2)}%</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
}

// 绘制置信度分布图
function drawConfidenceDistChart(result) {
    const ctx = document.getElementById('confidenceDistChart').getContext('2d');
    
    if (confidenceChart) {
        confidenceChart.destroy();
    }
    
    const confidences = result.confidences || [];
    if (confidences.length === 0) return;
    
    // 创建直方图数据
    const bins = createHistogram(confidences, 10);
    
    confidenceChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: bins.labels,
            datasets: [{
                label: '样本数量',
                data: bins.counts,
                backgroundColor: 'rgba(216, 67, 67, 0.6)',
                borderColor: 'rgba(216, 67, 67, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '置信度区间'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '样本数量'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createHistogram(data, binCount) {
    const min = Math.min(...data);
    const max = Math.max(...data);
    const binSize = (max - min) / binCount || 0.1;
    
    const bins = Array(binCount).fill(0);
    const labels = [];
    
    for (let i = 0; i < binCount; i++) {
        const binStart = min + i * binSize;
        const binEnd = min + (i + 1) * binSize;
        labels.push(`${(binStart * 100).toFixed(0)}-${(binEnd * 100).toFixed(0)}%`);
    }
    
    data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
        if (binIndex >= 0 && binIndex < binCount) {
            bins[binIndex]++;
        }
    });
    
    return { labels, counts: bins };
}

function generateColors(count) {
    const baseColors = [
        '#2e7d32', '#1976d2', '#f57c00', '#7b1fa2', 
        '#c62828', '#00838f', '#558b2f', '#6a1b9a',
        '#ef6c00', '#0097a7'
    ];
    
    const colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(baseColors[i % baseColors.length]);
    }
    return colors;
}

// 下载结果
function downloadResult() {
    if (!currentResult) {
        showMessage('没有可下载的结果', 'warning');
        return;
    }
    
    const dataStr = JSON.stringify(currentResult, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `fd_inference_${currentResult.inference_id || Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// 重置表单
function resetForm() {
    document.getElementById('inferenceForm').reset();
    document.getElementById('modelSelect').value = '';
    document.getElementById('dataFileSelect').value = '';
    document.getElementById('modelInfoContainer').style.display = 'none';
    document.getElementById('conditionInputContainer').style.display = 'none';
    document.getElementById('conditionInputsArea').innerHTML = '';
    document.getElementById('resultsSection').style.display = 'none';
    currentModelConfig = null;
    currentResult = null;
}

// 隐藏结果
function hideResults() {
    document.getElementById('resultsSection').style.display = 'none';
}

// 显示消息
function showMessage(message, type = 'info') {
    let alertDiv = document.querySelector('.alert-message');
    if (!alertDiv) {
        alertDiv = document.createElement('div');
        alertDiv.className = 'alert mt-3';
        const container = document.querySelector('.container');
        container.insertBefore(alertDiv, container.children[1]);
    }
    
    alertDiv.className = `alert alert-${type} alert-message mt-3`;
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

</script>

{% endblock %}
