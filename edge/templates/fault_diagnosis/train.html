{% extends "base.html" %}

{% block title %}è®­ç»ƒ - æ•…éšœè¯Šæ–­{% endblock %}

{% block content %}

<style>
:root {
    --fault-primary: #D84343;
    --fault-secondary: #FF8A8A;
    --fault-dark: #B71C1C;
}

/* é¡µé¢æ•´ä½“æ ·å¼ */
.train-page {
    background: transparent;
    min-height: 100vh;
    padding: 2rem 0 3rem;
}

/* é¡µé¢æ ‡é¢˜åŒºåŸŸ */
.page-header {
    background: transparent;
    color: #495057;
    padding: 0;
    margin-bottom: 2.5rem;
    border: none;
    text-align: center;
    max-width: 760px;
    margin-left: auto;
    margin-right: auto;
}

.page-header h2 {
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: var(--fault-primary);
    text-align: center;
}

.page-header p {
    opacity: 0.8;
    margin-bottom: 0;
    color: #6c757d;
    text-align: center;
}

/* ç¾åŒ–å¡ç‰‡æ ·å¼ */
.param-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    overflow: hidden;
    width: 100%;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
    transition: all 0.3s ease;
}

.param-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.param-card-header {
    background: #f8f9fa;
    color: #495057;
    padding: 1.5rem 2rem;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.param-card-header i {
    font-size: 1.2rem;
    color: var(--fault-primary);
}

.param-card-body {
    padding: 2rem;
}

.param-section {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.75rem;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.param-section:hover {
    background: #f8f9fa;
    border-color: var(--fault-primary);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

.param-subsection {
    border: 1px dashed rgba(216, 67, 67, 0.25);
    border-radius: 0.65rem;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    background: #ffffff;
    transition: background 0.2s ease;
}

.param-subsection:last-child {
    margin-bottom: 0;
}

.param-subsection-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--fault-primary);
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.85rem;
}

.param-subsection-title i {
    color: inherit;
}

.param-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    font-size: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #dee2e6;
}

.param-section h6 i {
    color: var(--fault-primary);
    margin-right: 0.5rem;
    font-size: 1em;
}

/* å‚æ•°è¡Œæ ·å¼ */
.param-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.param-row:last-child {
    margin-bottom: 0;
}

.param-item {
    display: flex;
    flex-direction: column;
}

.param-item.full-width {
    grid-column: 1 / -1;
}

@media (max-width: 768px) {
    .param-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
.form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    background-color: white;
}

.form-control:hover, .form-select:hover {
    border-color: var(--fault-primary);
}

.form-control:focus, .form-select:focus {
    border-color: var(--fault-primary);
    box-shadow: 0 0 0 0.2rem rgba(216, 67, 67, 0.15);
    outline: none;
}

.form-select-lg {
    padding: 0.75rem 1rem;
    font-size: 1rem;
}

/* æ ‡ç­¾æ ·å¼ */
.form-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.form-label.align-left {
    justify-content: flex-start;
}

.form-label i {
    color: var(--fault-primary);
    font-size: 0.9em;
}

/* æŒ‰é’® */
.btn-primary {
    background-color: var(--fault-primary);
    border-color: var(--fault-primary);
}

.btn-primary:hover {
    background-color: var(--fault-dark);
    border-color: var(--fault-dark);
}

.btn-outline-primary {
    color: var(--fault-primary);
    border-color: var(--fault-primary);
}

.btn-outline-primary:hover {
    background-color: var(--fault-primary);
    border-color: var(--fault-primary);
    color: #fff;
}

/* Badge & å¼€å…³ */
.badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    border-radius: 0.375rem;
    font-weight: 500;
}

.badge.bg-primary,
.badge.bg-danger {
    background-color: var(--fault-primary) !important;
    color: #fff;
}

.badge.bg-success {
    background-color: #27AE60 !important;
    color: #fff;
}

.badge.bg-warning {
    background-color: var(--fault-secondary) !important;
    color: #fff;
}

.form-text {
    font-size: 0.8125rem;
    color: #6c757d;
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.25rem;
}

.form-check-input:checked {
    background-color: var(--fault-primary);
    border-color: var(--fault-primary);
}

/* åŠ¨æ€å†…å®¹åˆ‡æ¢åŠ¨ç”» */
.fade-in {
    animation: fadeIn 0.3s ease-in-out;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* é”™è¯¯çŠ¶æ€æ ·å¼ */
.is-invalid {
    border-color: #dc3545 !important;
    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
}

.invalid-feedback {
    display: block;
    width: 100%;
    margin-top: 0.25rem;
    font-size: 0.875rem;
    color: #dc3545;
}

/* é¡µé¢å†… primary ç»Ÿä¸€æˆçº¢è‰²è°ƒ */
.text-primary {
    color: var(--fault-primary) !important;
}

.border-primary {
    border-color: var(--fault-primary) !important;
}
</style>


<div class="train-page">
<div class="container-fluid">
<div class="page-header">
    <h2>
        <i class="fas fa-tools me-2"></i>
        æ•…éšœè¯Šæ–­æ¨¡å‹è®­ç»ƒ
    </h2>
    <p>é…ç½®å¹¶è®­ç»ƒé¢å‘æ•…éšœè¯†åˆ«çš„åˆ†ç±»æ¨¡å‹ï¼Œæµç¨‹ä¸RULè®­ç»ƒä½“éªŒä¿æŒä¸€è‡´</p>
</div>

<div id="zeroCodeDiv">
    <form id="zeroCodeForm" novalidate>
        <!-- æ¨¡å‹é€‰æ‹© -->
        <div class="param-card mb-4">
            <div class="param-card-header">
                <i class="fas fa-robot"></i>
                <span>æ¨¡å‹é€‰æ‹©</span>
            </div>
            <div class="param-card-body">
                <div class="row align-items-end g-3">
                    <div class="col-md-8">
                        <label for="modelType" class="form-label align-left">
                            <i class="fas fa-cog"></i>
                            é€‰æ‹©æ¨¡å‹ç±»å‹
                        </label>
                        <select class="form-select form-select-lg" id="modelType" data-action="switch-model-type">
                            <option value="cnn_1d_classifier" selected>ğŸ–¼ï¸ CNN 1D åˆ†ç±»å™¨</option>
                            <option value="lstm_classifier">ğŸ“ˆ LSTM åˆ†ç±»å™¨</option>
                            <option value="resnet_1d_classifier">ğŸ”— ResNet 1D åˆ†ç±»å™¨</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="button" id="loadDefaultsBtn" class="btn btn-primary w-100 py-3">
                            <i class="fas fa-magic me-2"></i>
                            åŠ è½½é»˜è®¤é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹è¯´æ˜åŒºåŸŸ -->
        <div id="modelConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-info-circle"></i>
                    <span id="modelConfigTitle">æ¨¡å‹è¯´æ˜</span>
                </div>
                <div class="param-card-body">
                    <!-- åŠ¨æ€æ¨¡å‹é…ç½®å†…å®¹åŒºåŸŸï¼ˆä»…æ˜¾ç¤ºæ¨¡å‹è¯´æ˜ï¼‰ -->
                    <div id="dynamicModelConfig" class="fade-in">
                        <!-- æ¨¡å‹è¯´æ˜å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å‚æ•°é…ç½®åŒºåŸŸ -->
        <div id="paramConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-cog"></i>
                    <span>å‚æ•°é…ç½®</span>
                </div>
                <div class="param-card-body">
                    <!-- ç½‘ç»œå‚æ•° -->
                    <div class="param-section" id="networkParamsSection">
                        <h6><i class="fas fa-network-wired"></i> ç½‘ç»œå‚æ•°</h6>
                        <div id="networkParamsContent">
                            <div class="alert alert-info mb-3">
                                <small><i class="fas fa-info-circle me-2"></i>è¯·å…ˆé€‰æ‹©æ¨¡å‹ç±»å‹ï¼Œç½‘ç»œå‚æ•°å°†æ ¹æ®æ¨¡å‹ç±»å‹è‡ªåŠ¨æ˜¾ç¤º</small>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡/æ•°æ®å‚æ•° -->
                    <div class="param-section">
                        <h6><i class="fas fa-database"></i> ä»»åŠ¡/æ•°æ®å‚æ•°</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label align-left" id="sequenceLengthLabel">
                                    <i class="fas fa-ruler-horizontal"></i>
                                    <span>åºåˆ—é•¿åº¦</span>
                                </label>
                                <input type="number" class="form-control" id="sequenceLength" name="sequenceLength" value="50" min="10" max="200" aria-label="åºåˆ—é•¿åº¦" title="è¾“å…¥åºåˆ—çš„æ—¶é—´æ­¥é•¿åº¦">
                                <div class="form-text">è¾“å…¥åºåˆ—çš„æ—¶é—´æ­¥é•¿åº¦ï¼Œå½±å“æ¨¡å‹å¯¹æ—¶åºæ¨¡å¼çš„æ•æ‰èƒ½åŠ›</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label align-left" id="numClassesLabel">
                                    <i class="fas fa-tags"></i>
                                    <span>åˆ†ç±»æ ‡ç­¾</span>
                                </label>
                                <input type="text" class="form-control" id="numClasses" name="numClasses" value="" placeholder="å°†ä»è®­ç»ƒé›†æ–‡ä»¶è‡ªåŠ¨æå–" readonly style="background-color: #f8f9fa; cursor: not-allowed;">
                                <div class="form-text">
                                    <i class="fas fa-info-circle text-info me-1"></i>
                                    æ ‡ç­¾å°†ä»é€‰ä¸­çš„è®­ç»ƒé›†æ–‡ä»¶çš„å…ƒæ•°æ®ä¸­è‡ªåŠ¨æå–ï¼Œæ— éœ€æ‰‹åŠ¨è¾“å…¥
                                </div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label align-left" for="stride">
                                    <i class="fas fa-arrows-alt-h"></i>
                                    <span>çª—å£æ­¥é•¿</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="stride"
                                       name="stride"
                                       value="1"
                                       min="1"
                                       max="100"
                                       aria-label="çª—å£æ­¥é•¿">
                                <div class="form-text">æ»‘åŠ¨çª—å£çš„æ­¥é•¿ï¼Œç”¨äºä»æ—¶åºæ•°æ®ä¸­æå–æ ·æœ¬ã€‚æ­¥é•¿è¶Šå°ï¼Œç”Ÿæˆçš„æ ·æœ¬è¶Šå¤š</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¼˜åŒ–å™¨è®¾ç½® -->
                    <div class="param-section">
                        <h6><i class="fas fa-tachometer-alt"></i> ä¼˜åŒ–å™¨è®¾ç½®</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                    å­¦ä¹ ç‡
                                </label>
                                <input type="number" class="form-control" id="learningRate" name="learningRate" value="0.001" step="0.0001" min="0.00001" max="0.1" aria-label="å­¦ä¹ ç‡" title="å­¦ä¹ ç‡">
                                <div class="form-text">Adamä¼˜åŒ–å™¨çš„å­¦ä¹ ç‡ï¼Œé€šå¸¸åœ¨0.0001-0.01ä¹‹é—´</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æƒé‡è¡°å‡ (L2æ­£åˆ™åŒ–)
                                </label>
                                <input type="number" class="form-control" id="weightDecay" name="weightDecay" value="0.0001" step="0.00001" min="0" max="0.01" aria-label="æƒé‡è¡°å‡" title="æƒé‡è¡°å‡">
                                <div class="form-text">L2æ­£åˆ™åŒ–ç³»æ•°ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</div>
                            </div>
                        </div>
                    </div>

                    <!-- è®­ç»ƒæ§åˆ¶ -->
                    <div class="param-section">
                        <h6><i class="fas fa-cogs"></i> è®­ç»ƒæ§åˆ¶</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                    è®­ç»ƒè½®æ•°
                                </label>
                                <input type="number" class="form-control" id="numEpochs" name="numEpochs" value="50" min="1" max="500" aria-label="è®­ç»ƒè½®æ¬¡" title="è®­ç»ƒè½®æ¬¡">
                                <div class="form-text">æœ€å¤§è®­ç»ƒè½®æ•°</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æ‰¹æ¬¡å¤§å°
                                </label>
                                <input type="number" class="form-control" id="batchSize" name="batchSize" value="32" min="1" max="512" step="8" aria-label="æ‰¹æ¬¡å¤§å°" title="æ‰¹æ¬¡å¤§å°">
                                <div class="form-text">è®­ç»ƒæ‰¹æ¬¡å¤§å°ï¼Œå½±å“å†…å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦</div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                    æ—©åœè€å¿ƒå€¼
                                </label>
                                <input type="number" class="form-control" id="patience" name="patience" value="10" min="0" max="50" aria-label="æ—©åœè€å¿ƒ" title="æ—©åœè€å¿ƒ">
                                <div class="form-text">éªŒè¯æŸå¤±å¤šå°‘è½®ä¸ä¸‹é™åˆ™æ—©åœï¼Œ0è¡¨ç¤ºä¸å¯ç”¨æ—©åœ</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æ¢¯åº¦è£å‰ªèŒƒæ•°
                                </label>
                                <input type="number" class="form-control" id="clipGradNorm" name="clipGradNorm" value="5.0" step="0.1" min="0" max="20" aria-label="æ¢¯åº¦è£å‰ªèŒƒæ•°" title="æ¢¯åº¦è£å‰ªèŒƒæ•°">
                                <div class="form-text">æ¢¯åº¦è£å‰ªçš„æœ€å¤§èŒƒæ•°ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸</div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                    éšæœºç§å­
                                </label>
                                <input type="number" class="form-control" id="randomSeed" name="randomSeed" value="42" min="0" max="999999" aria-label="éšæœºç§å­" title="éšæœºç§å­">
                                <div class="form-text">éšæœºç§å­ï¼Œç¡®ä¿å®éªŒå¯é‡ç°</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    è®¡ç®—è®¾å¤‡
                                </label>
                                <select class="form-select" id="device" name="device" aria-label="è®¡ç®—è®¾å¤‡" title="è®¡ç®—è®¾å¤‡">
                                    <option value="cpu">CPU</option>
                                    <option value="gpu" selected>GPU</option>
                                    <option value="ascend">æ˜‡è…¾ (Ascend)</option>
                                </select>
                                <div class="form-text">è®­ç»ƒä½¿ç”¨çš„è®¡ç®—è®¾å¤‡ï¼ŒGPUé€Ÿåº¦æ›´å¿«</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®é›†é…ç½®åŒºåŸŸ -->
        <div id="datasetConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®é›†é…ç½®</span>
                </div>
                <div class="param-card-body">
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle"></i> æ•°æ®é›†é…ç½®è¯´æ˜</h6>
                        <p class="mb-2">æ•…éšœè¯Šæ–­é‡‡ç”¨ç›‘ç£å­¦ä¹ ï¼Œéœ€è¦é€‰æ‹©åŒ…å«ä¸åŒæ ‡ç­¾å’Œå·¥å†µçš„æ•°æ®æ–‡ä»¶è¿›è¡Œè®­ç»ƒã€‚</p>
                        <p class="mb-0">ç³»ç»Ÿå°†æ ¹æ®å·¥å†µæ¡ä»¶ç­›é€‰æ•°æ®æ–‡ä»¶ï¼Œè®­ç»ƒé›†å’Œæµ‹è¯•é›†å°†æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾çš„æ–‡ä»¶ï¼ˆæ­£å¸¸ã€å¼‚å¸¸ã€å„ç§æ•…éšœç±»å‹ç­‰ï¼‰ã€‚</p>
                        <p class="mb-0 mt-2">
                            <small class="text-muted">
                                éœ€è¦å¯¹åŸå§‹æ•°æ®åšæ¸…æ´—ã€å¯¹é½æˆ–å½’ä¸€åŒ–ï¼Ÿè¯·å…ˆå‰å¾€
                                <a href="{{ url_for('data_management.index') }}" class="text-decoration-none fw-bold">æ•°æ®ç®¡ç†æ¨¡å—</a>
                                å®Œæˆæ“ä½œï¼Œå†è¿”å›è®­ç»ƒé¡µé¢é€‰æ‹©é¢„å¤„ç†åçš„æ–‡ä»¶ã€‚
                            </small>
                        </p>
                    </div>

                    <!-- å·¥å†µé€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section">
                        <h6><i class="fas fa-filter"></i> å·¥å†µç­›é€‰</h6>
                        <div class="alert alert-info mb-3">
                            <small>
                                <i class="fas fa-info-circle me-2"></i>
                                é€‰æ‹©å·¥å†µæ¡ä»¶æ¥ç­›é€‰æ•°æ®æ–‡ä»¶ã€‚è®­ç»ƒé›†å’Œæµ‹è¯•é›†å°†æ˜¾ç¤ºæ‰€æœ‰æ ‡ç­¾çš„æ–‡ä»¶ï¼ˆä¸è¿‡æ»¤æ ‡ç­¾ï¼‰ã€‚
                            </small>
                        </div>
                        <div id="conditionSelectionArea">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <span class="ms-2 text-muted">åŠ è½½å·¥å†µé€‰é¡¹...</span>
                            </div>
                        </div>
                    </div>

                    <!-- è®­ç»ƒé›†æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section mt-4" id="trainFileSelectionArea" style="display: none;">
                        <h6><i class="fas fa-folder-open"></i> è®­ç»ƒé›†æ–‡ä»¶é€‰æ‹©</h6>
                        <div class="alert alert-success mb-3">
                            <small>
                                <i class="fas fa-check-circle me-2"></i>
                                å·²ç­›é€‰å‡º <span id="trainFileCount">0</span> ä¸ªç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ï¼ˆæ‰€æœ‰æ ‡ç­¾ï¼‰
                            </small>
                        </div>
                        <div id="trainFileList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                            <div class="text-muted text-center py-3">è¯·å…ˆé€‰æ‹©å·¥å†µæ¡ä»¶</div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTrainFiles()">
                                <i class="fas fa-check-square me-1"></i>å…¨é€‰
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllTrainFiles()">
                                <i class="fas fa-square me-1"></i>å–æ¶ˆå…¨é€‰
                            </button>
                        </div>
                    </div>

                    <div class="param-section dataset-section mt-4">
                        <h6><i class="fas fa-chart-pie"></i> æ•°æ®åˆ’åˆ†è®¾ç½®</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label" for="faultDiagnosisValSplit">
                                    <i class="fas fa-percentage"></i>
                                    <span>éªŒè¯é›†æ¯”ä¾‹</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="faultDiagnosisValSplit"
                                       name="faultDiagnosisValSplit"
                                       value="0.2"
                                       min="0.1"
                                       max="0.5"
                                       step="0.05"
                                       aria-label="éªŒè¯é›†æ¯”ä¾‹">
                                <div class="form-text">ä»è®­ç»ƒæ•°æ®ä¸­åˆ’åˆ†çš„éªŒè¯é›†æ¯”ä¾‹</div>
                            </div>
                        </div>
                        <div class="alert alert-light border">
                            <small>
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                ç›‘ç£å­¦ä¹ æ¨¡å¼ï¼šè®­ç»ƒé›†ç”¨äºå­¦ä¹ åˆ†ç±»æ¨¡å¼ï¼ŒéªŒè¯é›†ç”¨äºè°ƒå‚å’Œæ—©åœ
                            </small>
                        </div>
                    </div>

                    <!-- æµ‹è¯•é›†æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section mt-4" id="testFileSelectionArea" style="display: none;">
                        <h6><i class="fas fa-flask"></i> æµ‹è¯•é›†é…ç½®ï¼ˆå¯é€‰ï¼‰</h6>
                        <div id="testFileList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                            <div class="text-muted text-center py-3">è¯·å…ˆé€‰æ‹©å·¥å†µæ¡ä»¶</div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTestFiles()">
                                <i class="fas fa-check-square me-1"></i>å…¨é€‰
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllTestFiles()">
                                <i class="fas fa-square me-1"></i>å–æ¶ˆå…¨é€‰
                            </button>
                        </div>
                        <div class="alert alert-info border mt-3">
                            <small>
                                <i class="fas fa-info-circle text-info me-2"></i>
                                <strong>è¯„ä¼°è¯´æ˜ï¼š</strong>å¦‚æœæä¾›æµ‹è¯•é›†ï¼Œè®­ç»ƒå®Œæˆåå°†è‡ªåŠ¨è¯„ä¼°æ¨¡å‹æ€§èƒ½ï¼Œå¹¶è®¡ç®—åˆ†ç±»æŒ‡æ ‡ï¼ˆå‡†ç¡®ç‡ã€ç²¾ç¡®ç‡ã€å¬å›ç‡ã€F1åˆ†æ•°ç­‰ï¼‰
                            </small>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center mt-5 mb-5">
            <div class="row justify-content-center g-3">
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success btn-lg w-100 py-3 shadow-sm">
                        <i class="fas fa-play me-2"></i>
                        <strong>å¼€å§‹è®­ç»ƒ</strong>
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- è®­ç»ƒçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="trainingStatus" class="mt-4" style="display: none;">
    </div>
</div>
</div>
</div>

<!-- éšè—çš„æ¨¡æ¿åŒºåŸŸ -->
<div style="display: none;">
    <!-- CNN 1D åˆ†ç±»å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="cnn1dClassifierTemplate" class="model-config-template">
        <div class="alert alert-light border border-primary p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">ğŸ–¼ï¸</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-primary mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> 1D-CNN æ•…éšœåˆ†ç±»å™¨</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> éœ€è¦å¿«é€Ÿæ•æ‰å±€éƒ¨æ—¶åºæ¨¡å¼å¹¶å®Œæˆå¤šç±»åˆ«æ•…éšœåˆ¤åˆ«çš„ä»»åŠ¡</li>
                        <li><strong>ä¼˜åŠ¿:</strong> ç»“æ„ä¸RULæ¨¡å—ä¸€è‡´ï¼Œæ”¯æŒå¤šå°ºåº¦å·ç§¯ã€BatchNormä¸è½»é‡çº§åˆ†ç±»å¤´ï¼Œæ¨ç†æ•ˆç‡é«˜</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="param-section">
            <h6><i class="fas fa-wave-square"></i> å·ç§¯ç½‘ç»œå‚æ•°</h6>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-layer-group"></i>
                    å·ç§¯å †æ ˆ
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            å·ç§¯é€šé“é…ç½®
                        </label>
                        <input type="text" class="form-control" id="convChannels" name="convChannels" value="64,128,256" placeholder="64,128,256" aria-label="å·ç§¯é€šé“é…ç½®">
                        <div class="form-text">ä½¿ç”¨é€—å·åˆ†éš”çš„æ•´æ•°ï¼Œå®šä¹‰æ¯ä¸ªå·ç§¯å±‚çš„è¾“å‡ºé€šé“æ•°</div>
                    </div>
                    <div class="param-item">
                        <label class="form-label">
                            å·ç§¯æ ¸å¤§å°
                        </label>
                        <input type="text" class="form-control" id="kernelSizes" name="kernelSizes" value="7,5,3" placeholder="7,5,3" aria-label="å·ç§¯æ ¸å¤§å°">
                        <div class="form-text">ä¸å·ç§¯å±‚æ•°å¯¹åº”ï¼Œå»ºè®®é€å±‚å‡å°ä»¥è¦†ç›–å¤šå°ºåº¦ç‰¹å¾</div>
                    </div>
                </div>
            </div>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-shield-alt"></i>
                    æ­£åˆ™åŒ–ä¸æ¿€æ´»
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            Dropoutç‡
                        </label>
                        <input type="number" class="form-control" id="cnnDropout" name="dropout" value="0.3" step="0.05" min="0" max="0.6" aria-label="Dropoutç‡">
                        <div class="form-text">å·ç§¯å—ä¸åˆ†ç±»å¤´å…±åŒä½¿ç”¨çš„ä¸¢å¼ƒæ¯”ä¾‹ï¼Œå»ºè®®0.2-0.4</div>
                    </div>
                    <div class="param-item">
                        <label class="form-label">
                            æ¿€æ´»å‡½æ•°
                        </label>
                        <select class="form-select" id="cnnActivation" name="activation" aria-label="æ¿€æ´»å‡½æ•°">
                            <option value="relu" selected>ReLU</option>
                            <option value="leakyrelu">LeakyReLU</option>
                            <option value="gelu">GELU</option>
                            <option value="tanh">Tanh</option>
                            <option value="sigmoid">Sigmoid</option>
                        </select>
                        <div class="form-text">å·ç§¯å—ä¸åˆ†ç±»å¤´ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°ï¼Œä¸RULæ¨¡å—ä¿æŒä¸€è‡´</div>
                    </div>
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            ä½¿ç”¨BatchNorm
                        </label>
                        <select class="form-select" id="useBatchNorm" name="useBatchNorm" aria-label="BatchNorm">
                            <option value="true" selected>æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                        <div class="form-text">åœ¨æ¯ä¸ªå·ç§¯å±‚åä½¿ç”¨æ‰¹å½’ä¸€åŒ–ä»¥ç¨³å®šè®­ç»ƒ</div>
                    </div>
                    <div class="param-item">
                        <div class="form-text text-muted" style="margin-top: 2.6rem;">
                            å½“å‰ç‰ˆæœ¬é»˜è®¤ä½¿ç”¨å…¨å±€å¹³å‡æ± åŒ–ï¼Œä¿æŒä¸RULæ¨¡å—ä¸€è‡´çš„ç‰¹å¾èšåˆç­–ç•¥
                        </div>
                    </div>
                </div>
            </div>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-project-diagram"></i>
                    åˆ†ç±»å¤´é…ç½®
                </div>
                <div class="param-row">
                    <div class="param-item full-width">
                        <div class="alert alert-secondary mb-0">
                            <small>
                                <i class="fas fa-info-circle me-2"></i>
                                åˆ†ç±»å¤´æ²¿ç”¨æ ‡å‡†ç»“æ„ï¼ˆä¸¤å±‚å…¨è¿æ¥ + Dropoutï¼‰ï¼Œå®½åº¦æ ¹æ®å·ç§¯é€šé“è‡ªåŠ¨åŒ¹é…ã€‚
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- LSTM åˆ†ç±»å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="lstmClassifierTemplate" class="model-config-template">
        <div class="alert alert-light border border-success p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">ğŸ“ˆ</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-success mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> LSTM åˆ†ç±»å™¨</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> é€‚ç”¨äºå¤æ‚æ—¶åºæ•°æ®çš„æ•…éšœåˆ†ç±»ï¼Œé€šè¿‡LSTMæ•æ‰é•¿æœŸä¾èµ–å…³ç³»</li>
                        <li><strong>ä¼˜åŠ¿:</strong> å¼ºå¤§çš„åºåˆ—å»ºæ¨¡å’Œæ—¶é—´æ¨¡å¼å­¦ä¹ èƒ½åŠ›ï¼Œæ“…é•¿å¤„ç†é•¿åºåˆ—æ•°æ®</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="param-section lstm-section">
            <h6><i class="fas fa-network-wired"></i> LSTMç½‘ç»œå‚æ•°</h6>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        éšè—å•å…ƒæ•°
                    </label>
                    <input type="number" class="form-control" id="lstmHiddenUnits" name="lstmHiddenUnits" value="128" min="32" max="512" step="16" aria-label="éšè—å•å…ƒæ•°" title="LSTMéšè—å±‚çš„ç»´åº¦å¤§å°">
                    <div class="form-text">LSTMéšè—å±‚çš„ç»´åº¦å¤§å°ï¼Œå½±å“æ¨¡å‹å®¹é‡</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        LSTMå±‚æ•°
                    </label>
                    <input type="number" class="form-control" id="lstmNumLayers" name="lstmNumLayers" value="2" min="1" max="5" aria-label="LSTMå±‚æ•°" title="LSTMå±‚æ•°">
                    <div class="form-text">LSTMç½‘ç»œçš„å±‚æ•°ï¼Œå±‚æ•°è¶Šå¤šè¡¨è¾¾èƒ½åŠ›è¶Šå¼º</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        Dropoutç‡
                    </label>
                    <input type="number" class="form-control" id="lstmDropout" name="lstmDropout" value="0.3" step="0.05" min="0" max="0.5" aria-label="Dropoutç‡" title="Dropoutç‡">
                    <div class="form-text">LSTMå±‚é—´çš„dropoutæ¯”ä¾‹ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        æ¿€æ´»å‡½æ•°
                    </label>
                    <select class="form-select" id="lstmActivation" name="lstmActivation" aria-label="æ¿€æ´»å‡½æ•°" title="æ¿€æ´»å‡½æ•°">
                        <option value="tanh" selected>Tanh</option>
                        <option value="relu">ReLU</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="leakyrelu">LeakyReLU</option>
                        <option value="gelu">GELU</option>
                    </select>
                    <div class="form-text">åˆ†ç±»å¤´ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        åŒå‘LSTM
                    </label>
                    <select class="form-select" id="lstmBidirectional" name="lstmBidirectional" aria-label="åŒå‘LSTM" title="åŒå‘LSTM">
                        <option value="false" selected>å¦</option>
                        <option value="true">æ˜¯</option>
                    </select>
                    <div class="form-text">åŒå‘LSTMå¯ä»¥æ•æ‰æ­£åå‘æ—¶åºä¿¡æ¯ï¼Œæå‡æ€§èƒ½ä½†å¢åŠ è®¡ç®—é‡</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        æ³¨æ„åŠ›æœºåˆ¶
                    </label>
                    <select class="form-select" id="lstmUseAttention" name="lstmUseAttention" aria-label="æ³¨æ„åŠ›æœºåˆ¶" title="æ³¨æ„åŠ›æœºåˆ¶">
                        <option value="false" selected>å¦</option>
                        <option value="true">æ˜¯</option>
                    </select>
                    <div class="form-text">ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶èšåˆåºåˆ—ä¿¡æ¯ï¼Œæå‡åˆ†ç±»æ€§èƒ½</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ResNet 1D åˆ†ç±»å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="resnet1dClassifierTemplate" class="model-config-template">
        <div class="alert alert-light border border-primary p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">ğŸ”—</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-primary mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> 1D ResNet åˆ†ç±»å™¨ï¼ˆæ®‹å·®ç½‘ç»œï¼‰</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> é€‚ç”¨äºå¤æ‚æ—¶åºæ•°æ®çš„æ•…éšœåˆ†ç±»ï¼Œé€šè¿‡æ®‹å·®è¿æ¥è§£å†³æ·±å±‚ç½‘ç»œé€€åŒ–é—®é¢˜</li>
                        <li><strong>ä¼˜åŠ¿:</strong> æ”¯æŒæ›´æ·±çš„ç½‘ç»œç»“æ„ï¼Œè®­ç»ƒç¨³å®šï¼Œç‰¹å¾æå–èƒ½åŠ›å¼ºï¼Œé€‚åˆä¸­ç­‰å¤æ‚åº¦çš„æ—¶åºæ¨¡å¼</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="param-section resnet-section">
            <h6><i class="fas fa-layer-group"></i> ResNet 1D ç½‘ç»œå‚æ•°</h6>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        åŸºç¡€é€šé“æ•°
                    </label>
                    <input type="number" class="form-control" id="resnet1dBaseChannels" name="resnet1dBaseChannels" value="64" min="16" max="256" step="16" aria-label="åŸºç¡€é€šé“æ•°" title="æ®‹å·®å—çš„åŸºç¡€é€šé“æ•°">
                    <div class="form-text">æ®‹å·®å—çš„åŸºç¡€é€šé“æ•°ï¼Œåç»­å±‚ä¼šè‡ªåŠ¨ç¿»å€</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        ç½‘ç»œé…ç½®
                    </label>
                    <select class="form-select" id="resnet1dBlockConfig" name="resnet1dBlockConfig" aria-label="ç½‘ç»œé…ç½®" title="æ®‹å·®å—é…ç½®">
                        <option value="resnet_tiny">ResNet-Tiny [1,1] - è¶…è½»é‡</option>
                        <option value="resnet_small" selected>ResNet-Small [1,1,1,1] - è½»é‡</option>
                        <option value="resnet18">ResNet-18 [2,2,2,2] - æ ‡å‡†</option>
                        <option value="resnet34">ResNet-34 [3,4,6,3] - æ·±åº¦</option>
                    </select>
                    <div class="form-text">æ®‹å·®å—é…ç½®ï¼Œæ•°å­—è¡¨ç¤ºæ¯ä¸ªé˜¶æ®µçš„æ®‹å·®å—æ•°é‡</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        å·ç§¯æ ¸å¤§å°
                    </label>
                    <input type="number" class="form-control" id="resnet1dKernelSize" name="resnet1dKernelSize" value="3" min="3" max="7" step="2" aria-label="å·ç§¯æ ¸å¤§å°" title="æ®‹å·®å—ä¸­å·ç§¯æ ¸çš„å¤§å°">
                    <div class="form-text">æ®‹å·®å—ä¸­1Då·ç§¯æ ¸çš„å¤§å°ï¼Œé€šå¸¸ä¸ºå¥‡æ•°</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        Dropoutç‡
                    </label>
                    <input type="number" class="form-control" id="resnet1dDropout" name="resnet1dDropout" value="0.3" step="0.05" min="0" max="0.5" aria-label="Dropoutç‡" title="Dropoutç‡">
                    <div class="form-text">é˜²æ­¢è¿‡æ‹Ÿåˆçš„Dropoutæ¯”ä¾‹</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// æ¨¡å‹ç±»å‹é…ç½®æ•°æ®
const modelTypeConfigs = {
    cnn_1d_classifier: {
        title: "CNN 1D åˆ†ç±»å™¨ - æ¨¡å‹è¯´æ˜",
        icon: "ğŸ–¼ï¸",
        templateId: "cnn1dClassifierTemplate",
        description: {
            type: "1D CNN åˆ†ç±»å™¨",
            usage: "é€‚ç”¨äºæ—¶åºæ•°æ®çš„æ•…éšœåˆ†ç±»ï¼Œé€šè¿‡1Då·ç§¯æå–æ—¶åºç‰¹å¾",
            strength: "å¼ºå¤§çš„æ—¶åºç‰¹å¾æå–èƒ½åŠ›ï¼Œè®¡ç®—æ•ˆç‡é«˜ï¼Œé€‚åˆå®æ—¶æ¨ç†"
        }
    },
    lstm_classifier: {
        title: "LSTM åˆ†ç±»å™¨ - æ¨¡å‹è¯´æ˜",
        icon: "ğŸ“ˆ",
        templateId: "lstmClassifierTemplate",
        description: {
            type: "LSTM åˆ†ç±»å™¨",
            usage: "é€‚ç”¨äºå¤æ‚æ—¶åºæ•°æ®çš„æ•…éšœåˆ†ç±»ï¼Œé€šè¿‡LSTMæ•æ‰é•¿æœŸä¾èµ–å…³ç³»",
            strength: "å¼ºå¤§çš„åºåˆ—å»ºæ¨¡å’Œæ—¶é—´æ¨¡å¼å­¦ä¹ èƒ½åŠ›ï¼Œæ“…é•¿å¤„ç†é•¿åºåˆ—æ•°æ®"
        }
    },
    resnet_1d_classifier: {
        title: "ResNet 1D åˆ†ç±»å™¨ - æ¨¡å‹è¯´æ˜",
        icon: "ğŸ”—",
        templateId: "resnet1dClassifierTemplate",
        description: {
            type: "1D ResNet åˆ†ç±»å™¨ï¼ˆæ®‹å·®ç½‘ç»œï¼‰",
            usage: "é€‚ç”¨äºå¤æ‚æ—¶åºæ•°æ®çš„æ•…éšœåˆ†ç±»ï¼Œé€šè¿‡æ®‹å·®è¿æ¥è§£å†³æ·±å±‚ç½‘ç»œé€€åŒ–é—®é¢˜",
            strength: "æ”¯æŒæ›´æ·±çš„ç½‘ç»œç»“æ„ï¼Œè®­ç»ƒç¨³å®šï¼Œç‰¹å¾æå–èƒ½åŠ›å¼º"
        }
    }
};

function parseIntListInput(value, fallback = []) {
    if (value === null || value === undefined) {
        return [...fallback];
    }

    if (Array.isArray(value)) {
        const parsed = value
            .map((item) => parseInt(String(item).trim(), 10))
            .filter((num) => !Number.isNaN(num));
        return parsed.length ? parsed : [...fallback];
    }

    const normalized = String(value)
        .split(/[,ï¼Œ]/)
        .map((segment) => segment.trim())
        .filter(Boolean)
        .map((segment) => parseInt(segment, 10))
        .filter((num) => !Number.isNaN(num));

    return normalized.length ? normalized : [...fallback];
}

function normalizeDeviceTarget(value) {
    const normalized = (value || 'CPU').toString().trim().toLowerCase();
    if (normalized === 'gpu') {
        return 'GPU';
    }
    if (normalized === 'ascend' || normalized === 'npu' || normalized === 'atlas') {
        return 'Ascend';
    }
    return 'CPU';
}

// åˆ‡æ¢æ¨¡å‹ç±»å‹
function switchModelType(modelType) {
    console.log('åˆ‡æ¢åˆ°æ¨¡å‹ç±»å‹:', modelType);
    
    const config = modelTypeConfigs[modelType];
    if (!config) {
        console.error('æœªçŸ¥çš„æ¨¡å‹ç±»å‹:', modelType);
        showError('æ— æ•ˆçš„æ¨¡å‹ç±»å‹');
        return;
    }

    try {
        // æ›´æ–°æ¨¡å‹é…ç½®åŒºåŸŸæ ‡é¢˜
        updateModelConfigTitle(config);
        
        // æ·»åŠ åˆ‡æ¢åŠ¨ç”»
        const configContainer = document.getElementById('dynamicModelConfig');
        configContainer.classList.add('fade-in');
        
        // æ›´æ–°æ¨¡å‹å‚æ•°é…ç½®
        updateModelConfig(config);
        
        // æ¸…é™¤æ‰€æœ‰é”™è¯¯çŠ¶æ€
        clearAllErrors();
        
        // éšè—æ–‡ä»¶é€‰æ‹©åŒºåŸŸï¼ˆåˆ‡æ¢æ¨¡å‹åéœ€è¦é‡æ–°ç¡®è®¤å·¥å†µè®¾ç½®ï¼‰
        const fileSelectionArea = document.getElementById('fileSelectionArea');
        if (fileSelectionArea) {
            fileSelectionArea.style.display = 'none';
        }
        
    } catch (error) {
        console.error('åˆ‡æ¢æ¨¡å‹ç±»å‹æ—¶å‡ºé”™:', error);
        showError('åˆ‡æ¢æ¨¡å‹æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
}

// æ›´æ–°æ¨¡å‹é…ç½®åŒºåŸŸæ ‡é¢˜
function updateModelConfigTitle(config) {
    const titleElement = document.getElementById('modelConfigTitle');
    if (titleElement) {
        titleElement.textContent = `${config.icon} ${config.title}`;
    }
}

// æ›´æ–°æ¨¡å‹å‚æ•°é…ç½®
function updateModelConfig(config) {
    const container = document.getElementById('dynamicModelConfig');
    const networkParamsContent = document.getElementById('networkParamsContent');
    const template = document.getElementById(config.templateId);
    
    if (!container) {
        console.error('æ‰¾ä¸åˆ°åŠ¨æ€é…ç½®å®¹å™¨');
        return;
    }
    
    if (!networkParamsContent) {
        console.error('æ‰¾ä¸åˆ°ç½‘ç»œå‚æ•°å†…å®¹å®¹å™¨');
        return;
    }
    
    if (!template) {
        console.error(`æ‰¾ä¸åˆ°æ¨¡æ¿: ${config.templateId}`);
        return;
    }
    
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    networkParamsContent.innerHTML = '';
    
    // å¤åˆ¶æ¨¡æ¿å†…å®¹
    const templateContent = template.cloneNode(true);
    templateContent.style.display = 'block';
    templateContent.id = ''; // ç§»é™¤IDé¿å…å†²çª
    
    // æå–æ¨¡å‹è¯´æ˜å’Œç½‘ç»œå‚æ•°éƒ¨åˆ†
    const modelInfo = templateContent.querySelector('.alert');
    const networkParamsSection = templateContent.querySelector('.param-section');
    
    // å°†æ¨¡å‹è¯´æ˜æ·»åŠ åˆ°æ¨¡å‹é…ç½®åŒºåŸŸ
    if (modelInfo) {
        container.appendChild(modelInfo.cloneNode(true));
    }
    
    // å°†ç½‘ç»œå‚æ•°æ·»åŠ åˆ°ç½‘ç»œå‚æ•°éƒ¨åˆ†
    if (networkParamsSection) {
        // ç§»é™¤æ ‡é¢˜ï¼ˆå› ä¸ºå·²ç»æœ‰ç»Ÿä¸€çš„æ ‡é¢˜äº†ï¼‰
        const clonedSection = networkParamsSection.cloneNode(true);
        const titleElement = clonedSection.querySelector('h6');
        if (titleElement) {
            titleElement.remove();
        }

        // ç¡®ä¿å…‹éš†å…ƒç´ ä¸­çš„IDå”¯ä¸€æ€§
        const timestamp = Date.now();
        const randomSuffix = Math.random().toString(36).substr(2, 9);

        // å¤„ç†æœ‰IDçš„å…ƒç´ 
        const elementsWithId = clonedSection.querySelectorAll('[id]');
        elementsWithId.forEach((element, index) => {
            if (element.id) {
                const oldId = element.id;
                const newId = `${oldId}-dynamic-${timestamp}-${randomSuffix}-${index}`;
                element.id = newId;

                // æ›´æ–°å¯¹åº”çš„label[for]å±æ€§
                const relatedLabel = clonedSection.querySelector(`label[for="${oldId}"]`);
                if (relatedLabel) {
                    relatedLabel.setAttribute('for', newId);
                }
            }
        });

        // åªæ³¨å…¥å†…éƒ¨å‚æ•°è¡Œï¼Œé¿å…é¢å¤–åµŒå¥—çš„ param-section
        while (clonedSection.firstChild) {
            networkParamsContent.appendChild(clonedSection.firstChild);
        }
    }
    
    // æ›´æ–°ä»»åŠ¡/æ•°æ®å‚æ•°éƒ¨åˆ†çš„åºåˆ—é•¿åº¦å’Œåˆ†ç±»æ ‡ç­¾è¾“å…¥æ¡†
    updateTaskDataParams(config);
}

// æ›´æ–°ä»»åŠ¡/æ•°æ®å‚æ•°éƒ¨åˆ†
function updateTaskDataParams(config) {
    const modelType = document.getElementById('modelType')?.value;
    const sequenceLengthInput = document.getElementById('sequenceLength');
    const numClassesInput = document.getElementById('numClasses');
    
    // æ ¹æ®æ¨¡å‹ç±»å‹è®¾ç½®åºåˆ—é•¿åº¦çš„é»˜è®¤å€¼
    const seqLenMap = {
        'cnn_1d_classifier': 50,
        'lstm_classifier': 50,
        'resnet_1d_classifier': 50
    };
    
    if (sequenceLengthInput && seqLenMap[modelType]) {
        // å¦‚æœåºåˆ—é•¿åº¦è¾“å…¥æ¡†ä¸ºç©ºï¼Œè®¾ç½®é»˜è®¤å€¼
        if (!sequenceLengthInput.value) {
            sequenceLengthInput.value = seqLenMap[modelType];
        }
        
        // æŸ¥æ‰¾æ¨¡å‹ç‰¹å®šçš„åºåˆ—é•¿åº¦è¾“å…¥æ¡†ï¼ˆåœ¨ç½‘ç»œå‚æ•°éƒ¨åˆ†ï¼‰ï¼Œå¹¶åŒæ­¥å€¼
        setTimeout(() => {
            const modelSeqLenInput = document.querySelector(`input[id*="SeqLen"]`);
            if (modelSeqLenInput) {
                // å¦‚æœæ¨¡å‹ç‰¹å®šçš„è¾“å…¥æ¡†æœ‰å€¼ï¼ŒåŒæ­¥åˆ°é€šç”¨è¾“å…¥æ¡†
                if (modelSeqLenInput.value) {
                    sequenceLengthInput.value = modelSeqLenInput.value;
                } else {
                    // å¦åˆ™ï¼Œå°†é€šç”¨è¾“å…¥æ¡†çš„å€¼åŒæ­¥åˆ°æ¨¡å‹ç‰¹å®šçš„è¾“å…¥æ¡†
                    modelSeqLenInput.value = sequenceLengthInput.value;
                }
                
                // å»ºç«‹åŒå‘åŒæ­¥
                sequenceLengthInput.addEventListener('input', function syncSeqLen() {
                    if (modelSeqLenInput) {
                        modelSeqLenInput.value = this.value;
                    }
                });
                
                modelSeqLenInput.addEventListener('input', function syncSeqLen() {
                    if (sequenceLengthInput) {
                        sequenceLengthInput.value = this.value;
                    }
                });
            }
        }, 100);
    }
    
    // åˆ†ç±»æ ‡ç­¾ç”±updateLabelsFromSelectedFileså‡½æ•°è‡ªåŠ¨æ›´æ–°ï¼Œè¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨è®¾ç½®
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger fade-in shadow';
    errorDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 600px;';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>
        <strong>é”™è¯¯:</strong> ${message}
        <button type="button" class="btn-close" aria-label="å…³é—­" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(errorDiv);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        if (errorDiv && errorDiv.parentElement) {
            errorDiv.remove();
        }
    }, 3000);
}

// æ¸…é™¤æ‰€æœ‰é”™è¯¯çŠ¶æ€
function clearAllErrors() {
    document.querySelectorAll('.is-invalid').forEach(el => {
        el.classList.remove('is-invalid');
    });
    
    document.querySelectorAll('.invalid-feedback').forEach(el => {
        el.remove();
    });
}

// åŠ è½½é»˜è®¤é…ç½®
function loadDefaultConfiguration() {
    try {
        // é‡æ–°åˆå§‹åŒ–å½“å‰é€‰æ‹©çš„æ¨¡å‹
        const currentModelType = document.getElementById('modelType')?.value;
        if (currentModelType) {
            switchModelType(currentModelType);
        }
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        const successDiv = document.createElement('div');
        successDiv.className = 'alert alert-success fade-in';
        successDiv.style.cssText = 'position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 90%; max-width: 600px;';
        successDiv.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            <strong>æˆåŠŸ:</strong> é»˜è®¤é…ç½®å·²åŠ è½½
            <button type="button" class="btn-close" aria-label="å…³é—­" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(successDiv);
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(() => {
            if (successDiv.parentNode) {
                successDiv.remove();
            }
        }, 3000);
        
    } catch (error) {
        console.error('åŠ è½½é»˜è®¤é…ç½®å¤±è´¥:', error);
        showError('åŠ è½½é»˜è®¤é…ç½®å¤±è´¥');
    }
}

// é¡µé¢åˆå§‹åŒ–ï¼ˆå·²åˆå¹¶åˆ°ä¸‹é¢çš„å®Œæ•´åˆå§‹åŒ–å‡½æ•°ä¸­ï¼‰

// ä¸ºonchangeæ›¿æ¢åçš„å…ƒç´ æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
document.addEventListener('change', function(e) {
    const action = e.target.getAttribute('data-action');
    
    if (action === 'switch-model-type') {
        switchModelType(e.target.value);
    }
});

// ==================== æ•°æ®é›†é…ç½®ç›¸å…³å‡½æ•° ====================

// å·¥å†µé€‰æ‹©å’Œæ–‡ä»¶ç­›é€‰åŠŸèƒ½ï¼ˆç±»ä¼¼å¼‚å¸¸æ£€æµ‹ï¼Œä½†ä¸è¿‡æ»¤æ ‡ç­¾ï¼‰
let selectedConditions = {}; // {key: [value1, value2, ...]}
window.selectedConditions = selectedConditions; // ç¡®ä¿å…¨å±€å¯è®¿é—®
let trainFiles = []; // è®­ç»ƒé›†æ–‡ä»¶åˆ—è¡¨
let testFiles = []; // æµ‹è¯•é›†æ–‡ä»¶åˆ—è¡¨

// åŠ è½½å·¥å†µkeyåˆ—è¡¨
async function loadConditionKeys() {
    const area = document.getElementById('conditionSelectionArea');
    if (!area) {
        console.error('âŒ æœªæ‰¾åˆ°conditionSelectionAreaå…ƒç´ ');
        return;
    }
    
    try {
        area.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><span class="ms-2 text-muted">åŠ è½½å·¥å†µé€‰é¡¹...</span></div>';
        
        const response = await fetch('/fault_diagnosis/api/condition_keys');
        const result = await response.json();
        
        if (result.success) {
            if (result.keys && result.keys.length > 0) {
                console.log(`âœ… æ‰¾åˆ° ${result.keys.length} ä¸ªå·¥å†µkey:`, result.keys);
                renderConditionKeys(result.keys);
                // åŠ è½½å®Œå·¥å†µkeyåï¼ŒåŠ è½½æ‰€æœ‰æ•°æ®æ–‡ä»¶
                setTimeout(() => {
                    loadAllFiles();
                }, 500);
            } else {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å·¥å†µkeyï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æ–‡ä»¶');
                area.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-info-circle me-2"></i>æœªæ‰¾åˆ°å·¥å†µæ•°æ®ï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æ–‡ä»¶ã€‚å¦‚éœ€ä½¿ç”¨å·¥å†µç­›é€‰ï¼Œè¯·å…ˆè¿›è¡Œæ•°æ®æ ‡æ³¨ã€‚</div>';
                setTimeout(() => {
                    loadAllFiles();
                }, 500);
            }
        } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
        }
    } catch (error) {
        console.error('âŒ åŠ è½½å·¥å†µkeyå¤±è´¥:', error);
        area.innerHTML = '<div class="alert alert-danger mb-0">åŠ è½½å·¥å†µé€‰é¡¹å¤±è´¥: ' + error.message + '</div>';
    }
}

// æ¸²æŸ“å·¥å†µkeyé€‰æ‹©åŒºåŸŸ
function renderConditionKeys(keys) {
    const area = document.getElementById('conditionSelectionArea');
    if (!area) return;
    
    let html = '<div class="row g-3">';
    
    keys.forEach(key => {
        const valuesId = `conditionValues_${key}`;
        html += `
            <div class="col-md-6">
                <div class="card border">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-tag me-2 text-primary"></i>${key}
                        </h6>
                        <div id="${valuesId}" class="mt-2">
                            <div class="text-center py-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadConditionValues('${key}')">
                                    <i class="fas fa-chevron-down me-1"></i>å±•å¼€é€‰é¡¹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    area.innerHTML = html;
}

// åŠ è½½æŒ‡å®škeyçš„valueåˆ—è¡¨
async function loadConditionValues(key) {
    const container = document.getElementById(`conditionValues_${key}`);
    if (!container) return;
    
    try {
        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch(`/fault_diagnosis/api/condition_values?key=${encodeURIComponent(key)}`);
        const result = await response.json();
        
        if (result.success && result.values && result.values.length > 0) {
            renderConditionValues(key, result.values);
        } else {
            container.innerHTML = '<div class="text-muted small">æš‚æ— é€‰é¡¹</div>';
        }
    } catch (error) {
        console.error(`åŠ è½½å·¥å†µvalueå¤±è´¥ (${key}):`, error);
        container.innerHTML = '<div class="text-danger small">åŠ è½½å¤±è´¥</div>';
    }
}

// æ¸²æŸ“å·¥å†µvalueé€‰æ‹©åŒºåŸŸ
function renderConditionValues(key, values) {
    const container = document.getElementById(`conditionValues_${key}`);
    if (!container) return;
    
    let html = '<div class="d-flex flex-wrap gap-2">';
    
    values.forEach(value => {
        const isSelected = selectedConditions[key] && selectedConditions[key].includes(value);
        const btnId = `conditionBtn_${key}_${value}`;
        html += `
            <button type="button" 
                    class="btn btn-sm ${isSelected ? 'btn-primary' : 'btn-outline-primary'}" 
                    onclick="toggleConditionValue('${key}', '${value}')"
                    id="${btnId}">
                ${value}
                ${isSelected ? ' <i class="fas fa-check"></i>' : ''}
            </button>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// åˆ‡æ¢å·¥å†µvalueé€‰æ‹©
function toggleConditionValue(key, value) {
    if (!selectedConditions[key]) {
        selectedConditions[key] = [];
    }
    
    const index = selectedConditions[key].indexOf(value);
    if (index > -1) {
        selectedConditions[key].splice(index, 1);
    } else {
        selectedConditions[key].push(value);
    }
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    const btnId = `conditionBtn_${key}_${value}`;
    const btn = document.getElementById(btnId);
    if (btn) {
        if (selectedConditions[key].includes(value)) {
            btn.className = 'btn btn-sm btn-primary';
            btn.innerHTML = `${value} <i class="fas fa-check"></i>`;
        } else {
            btn.className = 'btn btn-sm btn-outline-primary';
            btn.innerHTML = value;
        }
    }
    
    // å¦‚æœè¯¥keyæ²¡æœ‰é€‰ä¸­ä»»ä½•valueï¼Œä»selectedConditionsä¸­ç§»é™¤
    if (selectedConditions[key].length === 0) {
        delete selectedConditions[key];
    }
    
    // é‡æ–°ç­›é€‰æ–‡ä»¶ï¼ˆå¦‚æœæœ‰é€‰æ‹©å·¥å†µï¼‰æˆ–é‡æ–°åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰é€‰æ‹©å·¥å†µï¼‰
    const hasConditions = Object.keys(selectedConditions).length > 0 && 
                          Object.values(selectedConditions).some(v => v.length > 0);
    
    if (hasConditions) {
        filterFiles();
    } else {
        loadAllFiles();
    }
}

// åŠ è½½æ‰€æœ‰æ•°æ®æ–‡ä»¶ï¼ˆä¸ç­›é€‰ï¼‰
async function loadAllFiles() {
    const area = document.getElementById('trainFileSelectionArea');
    const list = document.getElementById('trainFileList');
    const countSpan = document.getElementById('trainFileCount');
    const testArea = document.getElementById('testFileSelectionArea');
    const testList = document.getElementById('testFileList');
    
    if (!area || !list) {
        console.error('âŒ æœªæ‰¾åˆ°æ–‡ä»¶é€‰æ‹©åŒºåŸŸå…ƒç´ ');
        return;
    }
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        if (testList) testList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        // å¦‚æœæ²¡æœ‰é€‰æ‹©å·¥å†µï¼Œç›´æ¥åŠ è½½æ‰€æœ‰æ–‡ä»¶
        const hasConditions = Object.keys(selectedConditions).length > 0 && 
                              Object.values(selectedConditions).some(v => v.length > 0);
        
        if (!hasConditions) {
            // åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸ç­›é€‰ï¼‰
            const response = await fetch('/fault_diagnosis/api/processed_data');
            const result = await response.json();
            
            if (result.success) {
                console.log(`âœ… æˆåŠŸåŠ è½½ ${result.files.length} ä¸ªæ–‡ä»¶`);
                
                // æ•…éšœè¯Šæ–­ï¼šæ˜¾ç¤ºæ‰€æœ‰æ–‡ä»¶ï¼ˆä¸è¿‡æ»¤æ ‡ç­¾ï¼‰
                trainFiles = result.files || [];
                testFiles = result.files || [];
                
                console.log(`è®­ç»ƒé›†æ–‡ä»¶: ${trainFiles.length} ä¸ª, æµ‹è¯•é›†æ–‡ä»¶: ${testFiles.length} ä¸ª`);
                
                if (trainFiles.length > 0) {
                    renderFileList(list, trainFiles, 'train');
                    area.style.display = 'block';
                    if (countSpan) countSpan.textContent = trainFiles.length;
                    // è‡ªåŠ¨æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
                    setTimeout(() => updateLabelsFromSelectedFiles(), 100);
                } else {
                    list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶</div>';
                    area.style.display = 'block';
                    if (countSpan) countSpan.textContent = '0';
                }
                
                // æ˜¾ç¤ºæµ‹è¯•é›†
                if (testFiles.length > 0 && testList) {
                    renderFileList(testList, testFiles, 'test');
                    if (testArea) testArea.style.display = 'block';
                } else if (testList) {
                    testList.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶</div>';
                    if (testArea) testArea.style.display = 'block';
                }
            } else {
                throw new Error(result.error || 'åŠ è½½å¤±è´¥');
            }
        } else {
            // æœ‰å·¥å†µé€‰æ‹©ï¼Œè¿›è¡Œç­›é€‰
            await filterTrainFiles();
            await filterTestFiles();
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
    }
}

// ç­›é€‰æ–‡ä»¶
async function filterFiles() {
    // ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶
    await filterTrainFiles();
    
    // è‡ªåŠ¨ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶
    await filterTestFiles();
}

// ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶
async function filterTrainFiles() {
    const area = document.getElementById('trainFileSelectionArea');
    const list = document.getElementById('trainFileList');
    const countSpan = document.getElementById('trainFileCount');
    
    if (!area || !list) return;
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch('/fault_diagnosis/api/filter_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conditions: selectedConditions,
                file_type: 'train'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            trainFiles = result.files || [];
            
            if (trainFiles.length > 0) {
                renderFileList(list, trainFiles, 'train');
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = trainFiles.length;
                // è‡ªåŠ¨æ›´æ–°æ ‡ç­¾æ˜¾ç¤º
                updateLabelsFromSelectedFiles();
            } else {
                list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = '0';
            }
        } else {
            list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (error) {
        console.error('ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + error.message + '</div>';
    }
}

// ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶
async function filterTestFiles() {
    const area = document.getElementById('testFileSelectionArea');
    const list = document.getElementById('testFileList');
    
    if (!area || !list) return;
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch('/fault_diagnosis/api/filter_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conditions: selectedConditions,
                file_type: 'test'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            testFiles = result.files || [];
            
            if (testFiles.length > 0) {
                renderFileList(list, testFiles, 'test');
                area.style.display = 'block';
            } else {
                list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                area.style.display = 'block';
            }
        } else {
            list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (error) {
        console.error('ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + error.message + '</div>';
    }
}

// æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
function renderFileList(container, files, type) {
    if (!container) return;
    
    let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
    html += '<thead class="table-light"><tr>';
    html += '<th style="width: 40px;"><input type="checkbox" class="form-check-input" onchange="toggleAllFiles(this, \'' + type + '\')"></th>';
    html += '<th>æ–‡ä»¶å</th>';
    html += '<th>æ ‡ç­¾</th>';
    
    // æ·»åŠ å·¥å†µåˆ—
    const allKeys = Object.keys(selectedConditions);
    allKeys.forEach(key => {
        html += `<th>${key}</th>`;
    });
    
    html += '<th>å¤§å°</th>';
    html += '</tr></thead><tbody>';
    
    files.forEach((file, index) => {
        const conditions = file.conditions || {};
        html += '<tr>';
        html += `<td><input type="checkbox" class="form-check-input file-checkbox" data-filename="${file.filename}" data-type="${type}" onchange="updateLabelsFromSelectedFiles()"></td>`;
        html += `<td><small>${file.display_name || file.filename}</small></td>`;
        html += `<td><span class="badge bg-${file.label === 'æ­£å¸¸' ? 'success' : file.label === 'å¼‚å¸¸' ? 'danger' : 'warning'}">${file.label || 'æœªçŸ¥'}</span></td>`;
        
        // æ·»åŠ å·¥å†µå€¼
        allKeys.forEach(key => {
            const value = conditions[key] || '';
            html += `<td><small>${value || '<span class="text-muted">-</span>'}</small></td>`;
        });
        
        html += `<td><small>${formatFileSize(file.size || 0)}</small></td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰æ–‡ä»¶
function toggleAllFiles(checkbox, type) {
    const checkboxes = document.querySelectorAll(`.file-checkbox[data-type="${type}"]`);
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
    // å¦‚æœæ˜¯è®­ç»ƒé›†ï¼Œæ›´æ–°æ ‡ç­¾æ˜¾ç¤º
    if (type === 'train') {
        updateLabelsFromSelectedFiles();
    }
}

// ä»é€‰ä¸­çš„è®­ç»ƒé›†æ–‡ä»¶ä¸­æå–æ ‡ç­¾å¹¶æ›´æ–°æ˜¾ç¤º
function updateLabelsFromSelectedFiles() {
    const selectedTrainFiles = getSelectedFiles('train');
    
    // ä»æ–‡ä»¶å…ƒæ•°æ®ä¸­æå–æ‰€æœ‰å”¯ä¸€çš„æ ‡ç­¾
    const extractedLabels = new Set();
    for (const filename of selectedTrainFiles) {
        const fileInfo = trainFiles.find(f => f.filename === filename);
        if (fileInfo && fileInfo.label) {
            extractedLabels.add(fileInfo.label);
        }
    }
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const labels = Array.from(extractedLabels).sort();
    
    // æ›´æ–°æ‰€æœ‰æ¨¡å‹ç±»å‹çš„æ ‡ç­¾è¾“å…¥æ¡†ï¼ˆæ”¹ä¸ºåªè¯»æ˜¾ç¤ºï¼‰
    const labelInputs = document.querySelectorAll('input[id*="NumClasses"]');
    labelInputs.forEach(input => {
        if (labels.length > 0) {
            input.value = labels.join(',');
            input.readOnly = true;
            input.style.backgroundColor = '#f8f9fa';
            input.style.cursor = 'not-allowed';
        } else {
            input.value = '';
            input.readOnly = false;
            input.style.backgroundColor = '';
            input.style.cursor = '';
        }
    });
    
    // æ›´æ–°"ä»»åŠ¡/æ•°æ®å‚æ•°"éƒ¨åˆ†çš„åˆ†ç±»æ ‡ç­¾è¾“å…¥æ¡†
    const numClassesInput = document.getElementById('numClasses');
    if (numClassesInput) {
        if (labels.length > 0) {
            numClassesInput.value = labels.join(',');
        } else {
            numClassesInput.value = '';
        }
    }
    
    // æ›´æ–°æç¤ºä¿¡æ¯ï¼ˆä»ä»»åŠ¡/æ•°æ®å‚æ•°éƒ¨åˆ†çš„è¾“å…¥æ¡†è·å–ï¼‰
    if (numClassesInput) {
        const formText = numClassesInput.parentElement.querySelector('.form-text');
        if (formText) {
            if (labels.length > 0) {
                formText.innerHTML = `
                    <i class="fas fa-info-circle text-success me-1"></i>
                    å·²ä»é€‰ä¸­çš„è®­ç»ƒé›†æ–‡ä»¶ä¸­è‡ªåŠ¨æå– <strong>${labels.length}</strong> ä¸ªæ ‡ç­¾: <code>${labels.join(', ')}</code>
                `;
            } else {
                formText.innerHTML = `
                    <i class="fas fa-info-circle text-info me-1"></i>
                    è¯·é€‰æ‹©è®­ç»ƒé›†æ–‡ä»¶ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨ä»æ–‡ä»¶çš„å…ƒæ•°æ®ä¸­æå–æ ‡ç­¾
                `;
            }
        }
    }
}

// è·å–é€‰ä¸­çš„æ–‡ä»¶
function getSelectedFiles(type) {
    const checkboxes = document.querySelectorAll(`.file-checkbox[data-type="${type}"]:checked`);
    return Array.from(checkboxes).map(cb => cb.getAttribute('data-filename'));
}

// å…¨é€‰è®­ç»ƒé›†æ–‡ä»¶
function selectAllTrainFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="train"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// å–æ¶ˆå…¨é€‰è®­ç»ƒé›†æ–‡ä»¶
function deselectAllTrainFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="train"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// å…¨é€‰æµ‹è¯•é›†æ–‡ä»¶
function selectAllTestFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="test"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// å–æ¶ˆå…¨é€‰æµ‹è¯•é›†æ–‡ä»¶
function deselectAllTestFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="test"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// ç”Ÿæˆæ–‡ä»¶é€‰æ‹©æ¡†ï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™ä»¥é¿å…é”™è¯¯ï¼‰
function generateFileSelectionBoxes() {
    console.warn('generateFileSelectionBoxeså·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨å·¥å†µç­›é€‰å’Œæ–‡ä»¶é€‰æ‹©åŠŸèƒ½');
}

// æ›´æ–°æ•°æ®åˆ’åˆ†æ¯”ä¾‹ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨éªŒè¯é›†æ¯”ä¾‹è®¾ç½®ï¼‰
function updateDataSplitRatio() {
    // å·²åºŸå¼ƒï¼Œä¸å†ä½¿ç”¨
}

// é¡µé¢åˆå§‹åŒ–ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å«æ•°æ®é›†é…ç½®ï¼‰
document.addEventListener('DOMContentLoaded', async function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ¨¡å‹é…ç½®');
    
    try {
        // åˆå§‹åŒ–æ¨¡å‹ç±»å‹ï¼ˆé»˜è®¤é€‰æ‹©CNN 1Dåˆ†ç±»å™¨ï¼‰
        const defaultModelType = document.getElementById('modelType')?.value || 'cnn_1d_classifier';
        switchModelType(defaultModelType);
        
        // ä¸ºæ¨¡å‹ç±»å‹é€‰æ‹©æ·»åŠ å˜åŒ–ç›‘å¬
        const modelTypeSelect = document.getElementById('modelType');
        if (modelTypeSelect) {
            modelTypeSelect.addEventListener('change', function() {
                switchModelType(this.value);
            });
        }
        
        // ä¸ºåŠ è½½é»˜è®¤é…ç½®æŒ‰é’®æ·»åŠ åŠŸèƒ½
        document.getElementById('loadDefaultsBtn')?.addEventListener('click', function() {
            loadDefaultConfiguration();
        });
        
        // åŠ è½½å·¥å†µé€‰é¡¹ï¼ˆç±»ä¼¼å¼‚å¸¸æ£€æµ‹ï¼‰
        await loadConditionKeys();
        
        // æ•°æ®åˆ’åˆ†æ¯”ä¾‹å·²ç”±éªŒè¯é›†æ¯”ä¾‹è®¾ç½®å¤„ç†ï¼Œæ— éœ€é¢å¤–åˆå§‹åŒ–
        
    } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
});

// ç›‘å¬åˆ†ç±»æ ‡ç­¾å˜åŒ–ï¼ˆè‡ªåŠ¨æ›´æ–°æ–‡ä»¶é€‰æ‹©è¡¨æ ¼ï¼‰
// ä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼Œå› ä¸ºè¾“å…¥æ¡†æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼ŒIDä¼šè¢«ä¿®æ”¹
document.addEventListener('input', function(e) {
    const targetId = e.target.id || '';
    const className = e.target.className || '';
    
    // æ ‡ç­¾å˜åŒ–ä¸å†éœ€è¦è‡ªåŠ¨æ›´æ–°æ–‡ä»¶é€‰æ‹©ï¼ˆå·²æ”¹ä¸ºå·¥å†µç­›é€‰æ¨¡å¼ï¼‰
});

// è¡¨å•æäº¤å¤„ç†
document.getElementById('zeroCodeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    try {
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = new FormData(this);
        const trainingData = {};
        
        // è·å–æ¨¡å‹ç±»å‹
        const modelType = document.getElementById('modelType')?.value;
        trainingData.model_type = modelType;
        
        // ä»é€‰ä¸­çš„è®­ç»ƒé›†æ–‡ä»¶ä¸­æå–æ ‡ç­¾ï¼ˆä»å…ƒæ•°æ®ä¸­ï¼‰
        const selectedTrainFiles = getSelectedFiles('train');
        if (!selectedTrainFiles || selectedTrainFiles.length === 0) {
            showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®­ç»ƒé›†æ–‡ä»¶');
            return;
        }
        
        // ä»æ–‡ä»¶å…ƒæ•°æ®ä¸­æå–æ‰€æœ‰å”¯ä¸€çš„æ ‡ç­¾
        const extractedLabels = new Set();
        for (const filename of selectedTrainFiles) {
            const fileInfo = trainFiles.find(f => f.filename === filename);
            if (fileInfo && fileInfo.label) {
                extractedLabels.add(fileInfo.label);
            }
        }
        
        // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åºï¼ˆç¡®ä¿é¡ºåºä¸€è‡´ï¼‰
        const labels = Array.from(extractedLabels).sort();
        
        if (labels.length < 2) {
            showError(`ä»é€‰ä¸­çš„æ–‡ä»¶ä¸­åªæå–åˆ° ${labels.length} ä¸ªæ ‡ç­¾ï¼Œè‡³å°‘éœ€è¦2ä¸ªä¸åŒçš„æ ‡ç­¾ã€‚è¯·ç¡®ä¿é€‰æ‹©äº†åŒ…å«ä¸åŒæ ‡ç­¾çš„æ–‡ä»¶ã€‚`);
            return;
        }
        
        console.log(`ä»æ–‡ä»¶ä¸­æå–çš„æ ‡ç­¾: ${labels.join(', ')}`);
        trainingData.labels = labels;
        trainingData.num_classes = labels.length;  // åˆ†ç±»æ•°é‡ç­‰äºæ ‡ç­¾æ•°é‡
        
        // è·å–å·¥å†µè®¾ç½®ï¼ˆä»selectedConditionsæ„å»ºconditionsConfigï¼‰
        // selectedConditionsæ ¼å¼: {key: [value1, value2, ...]}
        const conditionsConfig = [];
        Object.keys(selectedConditions).forEach(key => {
            const values = selectedConditions[key].map(v => {
                // å°è¯•è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœå¤±è´¥åˆ™ä¿æŒå­—ç¬¦ä¸²
                const num = parseFloat(v);
                return isNaN(num) ? v : num;
            });
            if (values.length > 0) {
                conditionsConfig.push({ name: key, values: values });
            }
        });
        
        // å·¥å†µæ˜¯å¯é€‰çš„ï¼Œå¯ä»¥ä¸ºç©º
        trainingData.conditions = conditionsConfig;
        trainingData.num_conditions = conditionsConfig.length;
        
        // æ„å»ºfile_selectionsï¼šéœ€è¦ä»æ–‡ä»¶å…ƒæ•°æ®ä¸­è·å–æ ‡ç­¾å’Œå·¥å†µä¿¡æ¯
        const fileSelections = [];
        
        // ä¸ºæ¯ä¸ªé€‰ä¸­çš„è®­ç»ƒé›†æ–‡ä»¶æ„å»ºfile_selection
        for (const filename of selectedTrainFiles) {
            // ä»trainFilesä¸­æ‰¾åˆ°å¯¹åº”çš„æ–‡ä»¶ä¿¡æ¯
            const fileInfo = trainFiles.find(f => f.filename === filename);
            if (!fileInfo) {
                console.warn(`æœªæ‰¾åˆ°æ–‡ä»¶ä¿¡æ¯: ${filename}`);
                continue;
            }
            
            // ä»æ–‡ä»¶ä¿¡æ¯ä¸­è·å–æ ‡ç­¾
            const fileLabel = fileInfo.label || '';
            if (!fileLabel) {
                console.warn(`æ–‡ä»¶ ${filename} æ²¡æœ‰æ ‡ç­¾ä¿¡æ¯`);
                continue;
            }
            
            // æŸ¥æ‰¾æ ‡ç­¾åœ¨labelsåˆ—è¡¨ä¸­çš„ç´¢å¼•ï¼ˆä»1å¼€å§‹ï¼‰
            const labelIndex = labels.indexOf(fileLabel) + 1;
            if (labelIndex === 0) {
                console.warn(`æ–‡ä»¶ ${filename} çš„æ ‡ç­¾ "${fileLabel}" ä¸åœ¨æ ‡ç­¾åˆ—è¡¨ä¸­`);
                continue;
            }
            
            // ä»æ–‡ä»¶ä¿¡æ¯ä¸­è·å–å·¥å†µç»„åˆ
            const conditionCombo = fileInfo.conditions || {};
            
            // æ„å»ºfile_selection
            fileSelections.push({
                filename: filename,
                condition_combo: conditionCombo,
                label_index: labelIndex,
                label_name: fileLabel,
                combo_index: 0  // æš‚æ—¶è®¾ä¸º0ï¼Œåç»­å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
            });
        }
        
        if (fileSelections.length === 0) {
            showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„è®­ç»ƒé›†æ–‡ä»¶ï¼ˆæ–‡ä»¶å¿…é¡»åŒ…å«æ ‡ç­¾ä¿¡æ¯ï¼‰');
            return;
        }
        
        trainingData.file_selections = fileSelections;
        
        // æ”¶é›†æµ‹è¯•é›†æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        const selectedTestFiles = getSelectedFiles('test');
        if (selectedTestFiles && selectedTestFiles.length > 0) {
            // ä¸ºæµ‹è¯•é›†æ–‡ä»¶ä¹Ÿæ„å»ºfile_selectionsï¼ˆå¦‚æœéœ€è¦å•ç‹¬å¤„ç†æµ‹è¯•é›†ï¼‰
            // ç›®å‰æµ‹è¯•é›†æ–‡ä»¶ä¼šåœ¨æ•°æ®åˆ’åˆ†æ—¶å¤„ç†ï¼Œè¿™é‡Œæš‚æ—¶ä¸å•ç‹¬å¤„ç†
            trainingData.test_files = selectedTestFiles;
        }
        
        // è·å–åºåˆ—é•¿åº¦ï¼ˆä»ä»»åŠ¡/æ•°æ®å‚æ•°éƒ¨åˆ†ï¼‰
        const seqLenInput = document.getElementById('sequenceLength');
        trainingData.sequence_length = parseInt(seqLenInput?.value || '50');
        
        // è·å–æ­¥é•¿
        trainingData.stride = parseInt(formData.get('stride') || '1');
        
        // è·å–éªŒè¯é›†æ¯”ä¾‹ï¼ˆç±»ä¼¼å¼‚å¸¸æ£€æµ‹ï¼‰
        trainingData.validation_split = parseFloat(formData.get('faultDiagnosisValSplit') || '0.2');
        trainingData.random_seed = parseInt(formData.get('randomSeed') || '42');
        trainingData.dataset_mode = 'condition_filtered'; // ä½¿ç”¨å·¥å†µç­›é€‰æ¨¡å¼
        
        // è·å–è®­ç»ƒå‚æ•°
        trainingData.epochs = parseInt(formData.get('numEpochs') || '50');
        trainingData.batch_size = parseInt(formData.get('batchSize') || '32');
        trainingData.learning_rate = parseFloat(formData.get('learningRate') || '0.001');
        trainingData.weight_decay = parseFloat(formData.get('weightDecay') || '0.0001');
        trainingData.clip_grad_norm = parseFloat(formData.get('clipGradNorm') || '5.0');
        trainingData.patience = parseInt(formData.get('patience') || '10');
        trainingData.random_seed = parseInt(formData.get('randomSeed') || '42');
        const normalizedDevice = normalizeDeviceTarget(formData.get('device') || 'GPU');
        trainingData.device_target = normalizedDevice;
        trainingData.device = normalizedDevice;
        
        // è·å–æ¨¡å‹ç‰¹å®šå‚æ•°
        if (modelType === 'cnn_1d_classifier') {
            const convChannels = parseIntListInput(formData.get('convChannels'), [64, 128, 256]);
            const kernelSizes = parseIntListInput(formData.get('kernelSizes'), [7, 5, 3]);
            const dropoutValue = parseFloat(formData.get('dropout') || '0.3');
            const activationValue = formData.get('activation') || 'relu';
            const useBatchNormValue = (formData.get('useBatchNorm') ?? 'true').toString().toLowerCase();

            trainingData.conv_channels = convChannels;
            trainingData.kernel_sizes = kernelSizes;
            trainingData.num_conv_layers = convChannels.length || 3;
            trainingData.num_filters = convChannels[convChannels.length - 1] || convChannels[0] || 64;
            trainingData.kernel_size = kernelSizes[0] || 3;
            trainingData.dropout = Number.isFinite(dropoutValue) ? dropoutValue : 0.3;
            trainingData.activation = activationValue;
            trainingData.use_batch_norm = useBatchNormValue;
        } else if (modelType === 'lstm_classifier') {
            trainingData.hidden_units = parseInt(document.querySelector('input[id*="HiddenUnits"]')?.value || '128');
            trainingData.num_layers = parseInt(document.querySelector('input[id*="NumLayers"]')?.value || '2');
            trainingData.dropout = parseFloat(document.querySelector('input[id*="Dropout"]')?.value || '0.3');
            trainingData.activation = document.querySelector('select[id*="Activation"]')?.value || 'tanh';
            trainingData.bidirectional = document.querySelector('select[id*="Bidirectional"]')?.value || 'false';
            trainingData.use_attention = document.querySelector('select[id*="UseAttention"]')?.value || 'false';
        } else if (modelType === 'resnet_1d_classifier') {
            trainingData.base_channels = parseInt(document.querySelector('input[id*="BaseChannels"]')?.value || '64');
            trainingData.block_config = document.querySelector('select[id*="BlockConfig"]')?.value || 'resnet_small';
            trainingData.kernel_size = parseInt(document.querySelector('input[id*="KernelSize"]')?.value || '3');
            trainingData.dropout = parseFloat(document.querySelector('input[id*="Dropout"]')?.value || '0.3');
        }
        
        console.log('æäº¤è®­ç»ƒæ•°æ®:', trainingData);
        
        // æ˜¾ç¤ºæäº¤çŠ¶æ€
        const statusDiv = document.getElementById('trainingStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = '<div class="alert alert-info"><i class="fas fa-spinner fa-spin me-2"></i>æ­£åœ¨æäº¤è®­ç»ƒä»»åŠ¡...</div>';
        
        // å‘é€è®­ç»ƒè¯·æ±‚
        const response = await fetch('/fault_diagnosis/api/train', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(trainingData)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>è®­ç»ƒä»»åŠ¡å·²æäº¤</h5>
                    <p>ä»»åŠ¡ID: ${result.task_id}</p>
                    <p>${result.message}</p>
                </div>
            `;
            
            // å¯é€‰ï¼šè·³è½¬åˆ°è®­ç»ƒè¿›åº¦é¡µé¢
            setTimeout(() => {
                window.location.href = `/fault_diagnosis/training_progress?task_id=${result.task_id}`;
            }, 2000);
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>è®­ç»ƒä»»åŠ¡æäº¤å¤±è´¥</h5>
                    <p>${result.message}</p>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('æäº¤è®­ç»ƒä»»åŠ¡å¤±è´¥:', error);
        const statusDiv = document.getElementById('trainingStatus');
        statusDiv.style.display = 'block';
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <h5><i class="fas fa-exclamation-triangle me-2"></i>æäº¤å¤±è´¥</h5>
                <p>${error.message}</p>
            </div>
        `;
    }
});
</script>

<div class="text-center mt-5">
    <a href="/fault_diagnosis" class="btn btn-outline-primary btn-lg px-5 py-3">
        <i class="fas fa-arrow-left me-2"></i>
        è¿”å›æ•…éšœè¯Šæ–­ä¸»é¡µ
    </a>
</div>
{% endblock %}

