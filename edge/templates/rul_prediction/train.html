{% extends "base.html" %}

{% block title %}è®­ç»ƒ - RULé¢„æµ‹{% endblock %}

{% block content %}
<style>
/* é¡µé¢æ•´ä½“æ ·å¼ */
.train-page {
    background: #F4F7FE;
    min-height: 100vh;
    padding: 2rem 0;
}

/* é¡µé¢æ ‡é¢˜åŒºåŸŸ */
.page-header {
    background: transparent;
    color: #495057;
    padding: 0;
    margin-bottom: 2rem;
    border: none;
    text-align: center;
}

.page-header h2 {
    font-weight: 700;
    margin-bottom: 0.5rem;
    color: #008BB0;
    text-align: center;
}

.page-header p {
    opacity: 0.8;
    margin-bottom: 0;
    color: #6c757d;
    text-align: center;
}

/* ç¾åŒ–å¡ç‰‡æ ·å¼ */
.param-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    overflow: hidden;
    width: 100%;
    max-width: 1400px;
    margin-left: auto;
    margin-right: auto;
    transition: all 0.3s ease;
}

.param-card:hover {
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

.param-card-header {
    background: #f8f9fa;
    color: #495057;
    padding: 1.5rem 2rem;
    margin: 0;
    font-size: 1.1rem;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.param-card-header i {
    font-size: 1.2rem;
    color: #008BB0;
}

.param-card-body {
    padding: 2rem;
}

.param-section {
    background: #ffffff;
    border: 1px solid #dee2e6;
    border-radius: 0.75rem;
    padding: 1.75rem;
    margin-bottom: 1.5rem;
    transition: all 0.3s ease;
}

.param-section:hover {
    background: #f8f9fa;
    border-color: #008BB0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    transform: translateY(-1px);
}

.param-subsection {
    border: 1px dashed rgba(0, 139, 176, 0.2);
    border-radius: 0.65rem;
    padding: 1.25rem;
    margin-bottom: 1.25rem;
    background: #fdfefe;
    transition: background 0.2s ease;
}

.param-subsection:last-child {
    margin-bottom: 0;
}

.param-subsection-title {
    font-size: 0.9rem;
    font-weight: 600;
    color: #008BB0;
    display: flex;
    align-items: center;
    gap: 0.4rem;
    margin-bottom: 0.85rem;
}

.param-subsection-title i {
    color: inherit;
}

.param-section h6 {
    color: #495057;
    font-weight: 600;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    font-size: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #dee2e6;
}

.param-section h6 i {
    color: #008BB0;
    margin-right: 0.5rem;
    font-size: 1em;
}

/* å‚æ•°è¡Œæ ·å¼ */
.param-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
    align-items: start;
}

.param-row:last-child {
    margin-bottom: 0;
}

.param-item {
    display: flex;
    flex-direction: column;
}

.param-item.full-width {
    grid-column: 1 / -1;
}

@media (max-width: 768px) {
    .param-row {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
}

/* è¡¨å•æ§ä»¶ç¾åŒ– */
.form-control, .form-select {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    padding: 0.625rem 0.875rem;
    font-size: 0.9375rem;
    transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    background-color: white;
}

.form-control:hover, .form-select:hover {
    border-color: #008BB0;
}

.form-control:focus, .form-select:focus {
    border-color: #008BB0;
    box-shadow: 0 0 0 0.2rem rgba(0, 139, 176, 0.1);
    outline: none;
}

/* æ ‡ç­¾æ ·å¼ */
.form-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.form-label.align-left {
    justify-content: flex-start;
}

.badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.65rem;
    border-radius: 0.375rem;
    font-weight: 500;
}

.form-text {
    font-size: 0.8125rem;
    color: #6c757d;
    margin-top: 0.5rem;
}

/* æŒ‰é’®æ ·å¼ */
.btn-primary {
    background: linear-gradient(135deg, #63D2FF 0%, #008BB0 100%);
    border-color: #008BB0;
    color: white;
}

.btn-primary:hover {
    background: linear-gradient(135deg, #4FC3FF 0%, #007A9A 100%);
    border-color: #007A9A;
    color: white;
}

.btn-outline-primary {
    color: #008BB0;
    border-color: #008BB0;
}

.btn-outline-primary:hover {
    background: linear-gradient(135deg, #63D2FF 0%, #008BB0 100%);
    border-color: #008BB0;
    color: white;
}

/* è®­ç»ƒçŠ¶æ€æ ·å¼ */
.training-status {
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.training-status.active {
    background: #d1ecf1;
    border-color: #0dcaf0;
}

.training-status.completed {
    background: #d1e7dd;
    border-color: #198754;
}

.training-status.error {
    background: #f8d7da;
    border-color: #dc3545;
}

/* åŠ¨ç”»æ•ˆæœ */
.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
</style>

<div class="train-page">
    <div class="container-fluid">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header">
            <h2><i class="fas fa-chart-line me-2"></i>RULé¢„æµ‹æ¨¡å‹è®­ç»ƒ</h2>
            <p>é…ç½®å¹¶è®­ç»ƒç”¨äºå‰©ä½™ä½¿ç”¨å¯¿å‘½ï¼ˆRULï¼‰é¢„æµ‹çš„å›å½’æ¨¡å‹</p>
        </div>

<div id="zeroCodeDiv">
    <form id="zeroCodeForm" novalidate>
        <!-- æ¨¡å‹é€‰æ‹© -->
        <div class="param-card mb-4">
                <div class="param-card-header">
                    <i class="fas fa-robot"></i>
                    <span>æ¨¡å‹é€‰æ‹©</span>
                </div>
                <div class="param-card-body">
                <div class="row align-items-end g-3">
                    <div class="col-md-8">
                        <label for="modelType" class="form-label align-left">
                            <i class="fas fa-cog"></i>
                            é€‰æ‹©æ¨¡å‹ç±»å‹
                        </label>
                        <select class="form-select form-select-lg" id="modelType" data-action="switch-model-type">
                            <option value="bilstm_gru_regressor" selected>ğŸ“ˆ BiLSTM/GRU å›å½’å™¨</option>
                            <option value="cnn_1d_regressor">ğŸ–¼ï¸ 1D-CNN å›å½’å™¨</option>
                            <option value="transformer_encoder_regressor">âš¡ Transformer Encoder å›å½’å™¨</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button type="button" id="loadDefaultsBtn" class="btn btn-primary w-100 py-3">
                            <i class="fas fa-magic me-2"></i>
                            åŠ è½½é»˜è®¤é…ç½®
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡å‹è¯´æ˜åŒºåŸŸ -->
        <div id="modelConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-info-circle"></i>
                    <span id="modelConfigTitle">æ¨¡å‹è¯´æ˜</span>
                </div>
                <div class="param-card-body">
                    <div id="dynamicModelConfig" class="fade-in">
                        <!-- æ¨¡å‹è¯´æ˜å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å‚æ•°é…ç½®åŒºåŸŸ -->
        <div id="paramConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-cog"></i>
                    <span>å‚æ•°é…ç½®</span>
                </div>
                <div class="param-card-body">
                    <!-- ç½‘ç»œå‚æ•° -->
                    <div class="param-section" id="networkParamsSection">
                        <h6><i class="fas fa-network-wired"></i> ç½‘ç»œå‚æ•°</h6>
                        <div id="networkParamsContent">
                            <div class="alert alert-info mb-3">
                                <small><i class="fas fa-info-circle me-2"></i>è¯·å…ˆé€‰æ‹©æ¨¡å‹ç±»å‹ï¼Œç½‘ç»œå‚æ•°å°†æ ¹æ®æ¨¡å‹ç±»å‹è‡ªåŠ¨æ˜¾ç¤º</small>
                            </div>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡/æ•°æ®å‚æ•° -->
                    <div class="param-section">
                        <h6><i class="fas fa-database"></i> ä»»åŠ¡/æ•°æ®å‚æ•°</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label align-left" id="sequenceLengthLabel">
                                    <i class="fas fa-ruler-horizontal"></i>
                                    <span>åºåˆ—é•¿åº¦</span>
                                </label>
                                <input type="number" class="form-control" id="sequenceLength" name="sequenceLength" value="50" min="10" max="200" aria-label="åºåˆ—é•¿åº¦" title="è¾“å…¥åºåˆ—çš„æ—¶é—´æ­¥é•¿åº¦">
                                <div class="form-text">è¾“å…¥åºåˆ—çš„æ—¶é—´æ­¥é•¿åº¦ï¼Œå½±å“æ¨¡å‹å¯¹æ—¶åºæ¨¡å¼çš„æ•æ‰èƒ½åŠ›</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label align-left" for="stride">
                                    <i class="fas fa-arrows-alt-h"></i>
                                    <span>çª—å£æ­¥é•¿</span>
                                </label>
                                <input type="number"
                                       class="form-control"
                                       id="stride"
                                       name="stride"
                                       value="1"
                                       min="1"
                                       max="100"
                                       aria-label="çª—å£æ­¥é•¿">
                                <div class="form-text">æ»‘åŠ¨çª—å£çš„æ­¥é•¿ï¼Œç”¨äºä»æ—¶åºæ•°æ®ä¸­æå–æ ·æœ¬ã€‚æ­¥é•¿è¶Šå°ï¼Œç”Ÿæˆçš„æ ·æœ¬è¶Šå¤š</div>
                            </div>
                        </div>
                    </div>

                    <!-- ä¼˜åŒ–å™¨è®¾ç½® -->
                    <div class="param-section">
                        <h6><i class="fas fa-tachometer-alt"></i> ä¼˜åŒ–å™¨è®¾ç½®</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                      å­¦ä¹ ç‡
                                  </label>
                                <input type="number" class="form-control" id="learningRate" name="learningRate" value="0.001" step="0.0001" min="0.00001" max="0.1" aria-label="å­¦ä¹ ç‡" title="å­¦ä¹ ç‡">
                                <div class="form-text">Adamä¼˜åŒ–å™¨çš„å­¦ä¹ ç‡ï¼Œé€šå¸¸åœ¨0.0001-0.01ä¹‹é—´</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                      æƒé‡è¡°å‡ (L2æ­£åˆ™åŒ–)
                                  </label>
                                <input type="number" class="form-control" id="weightDecay" name="weightDecay" value="0.0001" step="0.00001" min="0" max="0.01" aria-label="æƒé‡è¡°å‡" title="æƒé‡è¡°å‡">
                                <div class="form-text">L2æ­£åˆ™åŒ–ç³»æ•°ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</div>
                            </div>
                        </div>
                    </div>

                    <!-- è®­ç»ƒæ§åˆ¶ -->
                    <div class="param-section">
                        <h6><i class="fas fa-cogs"></i> è®­ç»ƒæ§åˆ¶</h6>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                      è®­ç»ƒè½®æ•°
                                </label>
                                <input type="number" class="form-control" id="numEpochs" name="numEpochs" value="50" min="1" max="500" aria-label="è®­ç»ƒè½®æ¬¡" title="è®­ç»ƒè½®æ¬¡">
                                <div class="form-text">æœ€å¤§è®­ç»ƒè½®æ•°</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æ‰¹æ¬¡å¤§å°
                                </label>
                                <input type="number" class="form-control" id="batchSize" name="batchSize" value="32" min="1" max="512" step="8" aria-label="æ‰¹æ¬¡å¤§å°" title="æ‰¹æ¬¡å¤§å°">
                                <div class="form-text">è®­ç»ƒæ‰¹æ¬¡å¤§å°ï¼Œå½±å“å†…å­˜ä½¿ç”¨å’Œè®­ç»ƒé€Ÿåº¦</div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                      æ¢¯åº¦è£å‰ªèŒƒæ•°
                                  </label>
                                <input type="number" class="form-control" id="clipGradNorm" name="clipGradNorm" value="5.0" step="0.1" min="0" max="20" aria-label="æ¢¯åº¦è£å‰ªèŒƒæ•°" title="æ¢¯åº¦è£å‰ªèŒƒæ•°">
                                <div class="form-text">æ¢¯åº¦è£å‰ªçš„æœ€å¤§èŒƒæ•°ï¼Œé˜²æ­¢æ¢¯åº¦çˆ†ç‚¸</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æŸå¤±å‡½æ•°ç±»å‹
                                </label>
                                <select class="form-select" id="lossType" name="lossType" aria-label="æŸå¤±å‡½æ•°ç±»å‹" title="æŸå¤±å‡½æ•°ç±»å‹">
                                    <option value="mse" selected>MSE (å‡æ–¹è¯¯å·®)</option>
                                    <option value="mae">MAE (å¹³å‡ç»å¯¹è¯¯å·®)</option>
                                </select>
                                <div class="form-text">å›å½’ä»»åŠ¡çš„æŸå¤±å‡½æ•°ç±»å‹</div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                      æ—©åœè€å¿ƒå€¼
                                  </label>
                                <input type="number" class="form-control" id="patience" name="patience" value="10" min="0" max="50" aria-label="æ—©åœè€å¿ƒ" title="æ—©åœè€å¿ƒ">
                                <div class="form-text">éªŒè¯æŸå¤±å¤šå°‘è½®ä¸ä¸‹é™åˆ™æ—©åœï¼Œ0è¡¨ç¤ºä¸å¯ç”¨æ—©åœ</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    æ—©åœæ¨¡å¼
                                </label>
                                <select class="form-select" id="earlyStopMode" name="earlyStopMode" aria-label="æ—©åœæ¨¡å¼" title="æ—©åœæ¨¡å¼">
                                    <option value="loss" selected>Loss (æŸå¤±)</option>
                                    <option value="rmse">RMSE (å‡æ–¹æ ¹è¯¯å·®)</option>
                                    <option value="mae">MAE (å¹³å‡ç»å¯¹è¯¯å·®)</option>
                                </select>
                                <div class="form-text">æ—©åœåˆ¤æ–­ä¾æ®çš„æŒ‡æ ‡ï¼ˆå›å½’ä»»åŠ¡ç‰¹æœ‰ï¼‰</div>
                            </div>
                        </div>
                        <div class="param-row">
                            <div class="param-item">
                                <label class="form-label">
                                    éšæœºç§å­
                                </label>
                                <input type="number" class="form-control" id="randomSeed" name="randomSeed" value="42" min="0" max="999999" aria-label="éšæœºç§å­" title="éšæœºç§å­">
                                <div class="form-text">éšæœºç§å­ï¼Œç¡®ä¿å®éªŒå¯é‡ç°</div>
                            </div>
                            <div class="param-item">
                                <label class="form-label">
                                    è®¡ç®—è®¾å¤‡
                                </label>
                                <select class="form-select" id="device" name="device" aria-label="è®¡ç®—è®¾å¤‡" title="è®¡ç®—è®¾å¤‡">
                                    <option value="cpu">CPU</option>
                                    <option value="gpu" selected>GPU</option>
                                    <option value="ascend">æ˜‡è…¾ (Ascend)</option>
                                </select>
                                <div class="form-text">è®­ç»ƒä½¿ç”¨çš„è®¡ç®—è®¾å¤‡ï¼ŒGPUé€Ÿåº¦æ›´å¿«</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®é›†é…ç½®åŒºåŸŸ -->
        <div id="datasetConfig" class="mb-4">
            <div class="param-card">
                <div class="param-card-header">
                    <i class="fas fa-database"></i>
                    <span>æ•°æ®é›†é…ç½®</span>
                </div>
                <div class="param-card-body">
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle"></i> Unitçº§åˆ«æ•°æ®åˆ’åˆ†è¯´æ˜</h6>
                        <p class="mb-2"><strong>é‡è¦åŸåˆ™ï¼š</strong>RULé¢„æµ‹åŸºäºunitï¼ˆè¿è¡Œåºåˆ—ï¼‰çº§åˆ«ç‹¬ç«‹æ€§</p>
                        <p class="mb-2">âœ“ æ¯ä¸ªæ–‡ä»¶ = ä¸€ä¸ªç‹¬ç«‹çš„unit = ä¸€æ¡å®Œæ•´çš„run-to-failureè½¨è¿¹</p>
                        <p class="mb-0 mt-2">
                            <small class="text-muted">
                                éœ€è¦å¯¹åŸå§‹æ•°æ®åšæ¸…æ´—ã€å¯¹é½æˆ–å½’ä¸€åŒ–ï¼Ÿè¯·å…ˆå‰å¾€
                                <a href="{{ url_for('data_management.index') }}" class="text-decoration-none fw-bold">æ•°æ®ç®¡ç†æ¨¡å—</a>
                                å®Œæˆæ“ä½œï¼Œå†è¿”å›è®­ç»ƒé¡µé¢é€‰æ‹©é¢„å¤„ç†åçš„æ–‡ä»¶ã€‚
                            </small>
                        </p>
                    </div>

                    <!-- å·¥å†µé€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section">
                        <h6><i class="fas fa-filter"></i> å·¥å†µç­›é€‰</h6>
                        <div class="alert alert-info mb-3">
                            <small>
                                <i class="fas fa-info-circle me-2"></i>
                                é€‰æ‹©å·¥å†µæ¡ä»¶æ¥ç­›é€‰æ•°æ®æ–‡ä»¶ã€‚è®­ç»ƒé›†å’Œæµ‹è¯•é›†å°†æ˜¾ç¤ºæ‰€æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶ã€‚
                            </small>
                        </div>
                        <div id="conditionSelectionArea">
                            <div class="text-center py-3">
                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                <span class="ms-2 text-muted">åŠ è½½å·¥å†µé€‰é¡¹...</span>
                            </div>
                        </div>
                    </div>

                    <!-- è®­ç»ƒé›†æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section mt-4" id="trainFileSelectionArea" style="display: none;">
                        <h6><i class="fas fa-folder-open"></i> è®­ç»ƒUnitsé€‰æ‹©</h6>
                        <div class="alert alert-success mb-3">
                            <small>
                                <i class="fas fa-check-circle me-2"></i>
                                å·²ç­›é€‰å‡º <span id="trainFileCount">0</span> ä¸ªè®­ç»ƒunitsï¼ˆæ¯ä¸ªunitæ˜¯å®Œæ•´çš„run-to-failureè½¨è¿¹ï¼‰
                            </small>
                        </div>
                        <div id="trainFileList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                            <div class="text-muted text-center py-3">è¯·å…ˆé€‰æ‹©å·¥å†µæ¡ä»¶</div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTrainFiles()">
                                <i class="fas fa-check-square me-1"></i>å…¨é€‰
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllTrainFiles()">
                                <i class="fas fa-square me-1"></i>å–æ¶ˆå…¨é€‰
            </button>
                        </div>
                    </div>

                    <!-- éªŒè¯é›†æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section mt-4" id="valFileSelectionArea" style="display: none;">
                        <h6><i class="fas fa-check-circle"></i> éªŒè¯Unitsé€‰æ‹©</h6>
                        <div class="alert alert-info mb-3">
                            <small>
                                <i class="fas fa-info-circle me-2"></i>
                                å·²ç­›é€‰å‡º <span id="valFileCount">0</span> ä¸ªéªŒè¯unitsï¼ˆæ¯ä¸ªunitæ˜¯å®Œæ•´çš„run-to-failureè½¨è¿¹ï¼‰
                            </small>
                        </div>
                        <div id="valFileList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                            <div class="text-muted text-center py-3">è¯·å…ˆé€‰æ‹©å·¥å†µæ¡ä»¶</div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllValFiles()">
                                <i class="fas fa-check-square me-1"></i>å…¨é€‰
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllValFiles()">
                                <i class="fas fa-square me-1"></i>å–æ¶ˆå…¨é€‰
                            </button>
                        </div>
                        <div class="alert alert-light border mt-3">
                            <small>
                                <i class="fas fa-lightbulb text-warning me-2"></i>
                                <strong>Unitçº§åˆ«ç‹¬ç«‹æ€§ï¼š</strong>éªŒè¯unitså¿…é¡»ä¸è®­ç»ƒunitså®Œå…¨ç‹¬ç«‹ã€‚å»ºè®®é€‰æ‹©2-3ä¸ªå®Œæ•´çš„unitsã€‚æ¯ä¸ªunitåŒ…å«å®Œæ•´çš„é€€åŒ–è¿‡ç¨‹ï¼ˆRULä»maxåˆ°0ï¼‰ï¼Œä¸å¯æˆªæ–­æˆ–æ··åˆã€‚
                            </small>
                        </div>
                    </div>

                    <!-- æµ‹è¯•é›†æ–‡ä»¶é€‰æ‹©åŒºåŸŸ -->
                    <div class="param-section dataset-section mt-4" id="testFileSelectionArea" style="display: none;">
                        <h6><i class="fas fa-flask"></i> æµ‹è¯•Unitsé…ç½®ï¼ˆå¯é€‰ï¼‰</h6>
                        <div id="testFileList" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 1rem;">
                            <div class="text-muted text-center py-3">è¯·å…ˆé€‰æ‹©å·¥å†µæ¡ä»¶</div>
                        </div>
                        <div class="mt-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllTestFiles()">
                                <i class="fas fa-check-square me-1"></i>å…¨é€‰
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" onclick="deselectAllTestFiles()">
                                <i class="fas fa-square me-1"></i>å–æ¶ˆå…¨é€‰
                            </button>
                        </div>
                        <div class="alert alert-info border mt-3">
                            <small>
                                <i class="fas fa-info-circle text-info me-2"></i>
                                <strong>æµ‹è¯•é›†è¯´æ˜ï¼š</strong>æµ‹è¯•unitsç”¨äºæœ€ç»ˆè¯„ä¼°æ¨¡å‹æ€§èƒ½ã€‚ä¸è®­ç»ƒ/éªŒè¯unitså®Œå…¨ç‹¬ç«‹ï¼Œè®¡ç®—RMSEã€MAEã€RÂ²ç­‰æŒ‡æ ‡ã€‚æ¯ä¸ªunitæ˜¯å®Œæ•´çš„é€€åŒ–åºåˆ—ã€‚
                            </small>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center mt-5 mb-5">
            <div class="row justify-content-center g-3">
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success btn-lg w-100 py-3 shadow-sm">
                        <i class="fas fa-play me-2"></i>
                        <strong>å¼€å§‹è®­ç»ƒ</strong>
                    </button>
                </div>
            </div>
        </div>
    </form>

    <!-- è®­ç»ƒçŠ¶æ€æ˜¾ç¤ºåŒºåŸŸ -->
    <div id="trainingStatus" class="mt-4" style="display: none;">
    </div>
</div>
</div>

<!-- æ¨¡å‹é…ç½®æ¨¡æ¿ -->
<div id="modelConfigTemplates" style="display: none;">
    <!-- BiLSTM/GRU å›å½’å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="bilstmGruRegressorTemplate" class="model-config-template">
        <div class="alert alert-light border border-danger p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">ğŸ“ˆ</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-danger mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> BiLSTM/GRU å›å½’å™¨</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> é€‚ç”¨äºæ—¶åºæ•°æ®çš„RULé¢„æµ‹ï¼Œé€šè¿‡åŒå‘RNNæ•æ‰å‰åæ—¶åºä¿¡æ¯</li>
                        <li><strong>ä¼˜åŠ¿:</strong> å¼ºå¤§çš„åºåˆ—å»ºæ¨¡èƒ½åŠ›ï¼Œæ”¯æŒæ³¨æ„åŠ›æœºåˆ¶ï¼Œé€‚åˆå¤æ‚æ—¶åºæ¨¡å¼</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="param-section">
            <h6><i class="fas fa-network-wired"></i> RNNç½‘ç»œå‚æ•°</h6>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        RNNç±»å‹
                    </label>
                    <select class="form-select" id="rnnType" name="rnnType" aria-label="RNNç±»å‹" title="RNNç±»å‹">
                        <option value="lstm" selected>LSTM</option>
                        <option value="gru">GRU</option>
                    </select>
                    <div class="form-text">é€‰æ‹©RNNç±»å‹ï¼ŒLSTMè®°å¿†èƒ½åŠ›æ›´å¼ºï¼ŒGRUè®¡ç®—æ›´å¿«</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        éšè—å•å…ƒæ•°
                    </label>
                    <input type="number" class="form-control" id="hiddenUnits" name="hiddenUnits" value="128" min="32" max="512" step="16" aria-label="éšè—å•å…ƒæ•°" title="RNNéšè—å±‚çš„ç»´åº¦å¤§å°">
                    <div class="form-text">RNNéšè—å±‚çš„ç»´åº¦å¤§å°ï¼Œå½±å“æ¨¡å‹å®¹é‡</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        RNNå±‚æ•°
                    </label>
                    <input type="number" class="form-control" id="numLayers" name="numLayers" value="2" min="1" max="5" aria-label="RNNå±‚æ•°" title="RNNå±‚æ•°">
                    <div class="form-text">RNNç½‘ç»œçš„å±‚æ•°ï¼Œå±‚æ•°è¶Šå¤šè¡¨è¾¾èƒ½åŠ›è¶Šå¼º</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        Dropoutç‡
                    </label>
                    <input type="number" class="form-control" id="dropout" name="dropout" value="0.3" step="0.05" min="0" max="0.5" aria-label="Dropoutç‡" title="Dropoutç‡">
                    <div class="form-text">RNNå±‚é—´çš„dropoutæ¯”ä¾‹ï¼Œé˜²æ­¢è¿‡æ‹Ÿåˆ</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        æ¿€æ´»å‡½æ•°
                    </label>
                    <select class="form-select" id="activation" name="activation" aria-label="æ¿€æ´»å‡½æ•°" title="æ¿€æ´»å‡½æ•°">
                        <option value="relu" selected>ReLU</option>
                        <option value="tanh">Tanh</option>
                        <option value="sigmoid">Sigmoid</option>
                        <option value="leakyrelu">LeakyReLU</option>
                        <option value="gelu">GELU</option>
                    </select>
                    <div class="form-text">å›å½’å¤´ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        åŒå‘RNN
                    </label>
                    <select class="form-select" id="bidirectional" name="bidirectional" aria-label="åŒå‘RNN" title="åŒå‘RNN">
                        <option value="true" selected>æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                    <div class="form-text">åŒå‘RNNå¯ä»¥æ•æ‰æ­£åå‘æ—¶åºä¿¡æ¯ï¼Œæå‡æ€§èƒ½ä½†å¢åŠ è®¡ç®—é‡</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">
                        æ³¨æ„åŠ›æœºåˆ¶
                    </label>
                    <select class="form-select" id="useAttention" name="useAttention" aria-label="æ³¨æ„åŠ›æœºåˆ¶" title="æ³¨æ„åŠ›æœºåˆ¶">
                        <option value="true" selected>æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                    <div class="form-text">ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶èšåˆåºåˆ—ä¿¡æ¯ï¼Œæå‡å›å½’æ€§èƒ½</div>
                </div>
                <div class="param-item">
                    <label class="form-label">
                        å±‚å½’ä¸€åŒ–
                    </label>
                    <select class="form-select" id="useLayerNorm" name="useLayerNorm" aria-label="å±‚å½’ä¸€åŒ–" title="å±‚å½’ä¸€åŒ–">
                        <option value="true" selected>æ˜¯</option>
                        <option value="false">å¦</option>
                    </select>
                    <div class="form-text">åœ¨å›å½’å¤´ä¸­ä½¿ç”¨å±‚å½’ä¸€åŒ–ï¼Œç¨³å®šè®­ç»ƒè¿‡ç¨‹å¹¶æå‡æ€§èƒ½</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 1D-CNN å›å½’å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="cnn1dRegressorTemplate" class="model-config-template">
        <div class="alert alert-light border border-primary p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">ğŸ–¼ï¸</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-primary mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> 1D-CNN å›å½’å™¨</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> éœ€è¦æ•æ‰å±€éƒ¨æ—¶åºæ¨¡å¼ã€æ”¯æŒå¤§æ‰¹é‡è®­ç»ƒçš„RULä»»åŠ¡</li>
                        <li><strong>ä¼˜åŠ¿:</strong> å¹¶è¡Œå·ç§¯æå–å¤šå°ºåº¦ç‰¹å¾ï¼ŒBatchNorm ç¨³å®šè®­ç»ƒï¼Œæ¨ç†é€Ÿåº¦å¿«</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="param-section">
            <h6><i class="fas fa-wave-square"></i> å·ç§¯ç½‘ç»œå‚æ•°</h6>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-layer-group"></i>
                    å·ç§¯å †æ ˆ
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            å·ç§¯é€šé“é…ç½®
                        </label>
                        <input type="text" class="form-control" id="convChannels" name="convChannels" value="64,128,256" placeholder="64,128,256" aria-label="å·ç§¯é€šé“é…ç½®">
                        <div class="form-text">ä½¿ç”¨é€—å·åˆ†éš”çš„æ•´æ•°ï¼Œå®šä¹‰æ¯ä¸ªå·ç§¯å±‚çš„è¾“å‡ºé€šé“æ•°</div>
                    </div>
                    <div class="param-item">
                        <label class="form-label">
                            å·ç§¯æ ¸å¤§å°
                        </label>
                        <input type="text" class="form-control" id="kernelSizes" name="kernelSizes" value="7,5,3" placeholder="7,5,3" aria-label="å·ç§¯æ ¸å¤§å°">
                        <div class="form-text">ä¸å·ç§¯å±‚æ•°å¯¹åº”ï¼Œå»ºè®®é€å±‚å‡å°</div>
                    </div>
                </div>
            </div>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-shield-alt"></i>
                    æ­£åˆ™åŒ–ä¸æ¿€æ´»
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            Dropoutç‡
                        </label>
                        <input type="number" class="form-control" id="cnnDropout" name="dropout" value="0.3" step="0.05" min="0" max="0.6" aria-label="Dropoutç‡">
                        <div class="form-text">å·ç§¯å—ä¸å›å½’å¤´çš„ä¸¢å¼ƒæ¯”ä¾‹ï¼Œå»ºè®®0.2-0.4</div>
                    </div>
                    <div class="param-item">
                        <label class="form-label">
                            æ¿€æ´»å‡½æ•°
                        </label>
                        <select class="form-select" id="cnnActivation" name="activation" aria-label="æ¿€æ´»å‡½æ•°">
                            <option value="relu" selected>ReLU</option>
                            <option value="leakyrelu">LeakyReLU</option>
                            <option value="gelu">GELU</option>
                            <option value="tanh">Tanh</option>
                            <option value="sigmoid">Sigmoid</option>
                        </select>
                        <div class="form-text">å·ç§¯å—ä¸å›å½’å¤´ä½¿ç”¨çš„æ¿€æ´»å‡½æ•°</div>
                    </div>
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            æ± åŒ–ç­–ç•¥
                        </label>
                        <select class="form-select" id="pooling" name="pooling" aria-label="æ± åŒ–ç­–ç•¥">
                            <option value="avg" selected>å…¨å±€å¹³å‡æ± åŒ–</option>
                            <option value="max">å…¨å±€æœ€å¤§æ± åŒ–</option>
                            <option value="flatten">å±•å¹³åºåˆ—</option>
                        </select>
                        <div class="form-text">å†³å®šæ—¶åºç»´åº¦çš„èšåˆæ–¹å¼ï¼Œflatten ä¼šå¢åŠ å…¨è¿æ¥å‚æ•°é‡</div>
                    </div>
                    <div class="param-item">
                        <label class="form-label">
                            ä½¿ç”¨BatchNorm
                        </label>
                        <select class="form-select" id="useBatchNorm" name="useBatchNorm" aria-label="BatchNorm">
                            <option value="true" selected>æ˜¯</option>
                            <option value="false">å¦</option>
                        </select>
                        <div class="form-text">åœ¨æ¯ä¸ªå·ç§¯å±‚åä½¿ç”¨æ‰¹å½’ä¸€åŒ–ä»¥ç¨³å®šè®­ç»ƒ</div>
                    </div>
                </div>
            </div>

            <div class="param-subsection">
                <div class="param-subsection-title">
                    <i class="fas fa-project-diagram"></i>
                    å›å½’å¤´é…ç½®
                </div>
                <div class="param-row">
                    <div class="param-item">
                        <label class="form-label">
                            å…¨è¿æ¥å±‚å®½åº¦
                        </label>
                        <input type="number" class="form-control" id="fcUnits" name="fcUnits" value="256" min="64" max="512" step="32" aria-label="å…¨è¿æ¥å±‚å®½åº¦">
                        <div class="form-text">å›å½’å¤´é¦–å±‚çš„ç¥ç»å…ƒæ•°é‡</div>
                    </div>
                    <div class="param-item">
                        <div class="form-text text-muted" style="margin-top: 2.6rem;">
                            ç»“åˆä¸Šæ–¹æ± åŒ–ç­–ç•¥è°ƒèŠ‚å›å½’å¤´å®¹é‡
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transformer Encoder å›å½’å™¨å‚æ•°æ¨¡æ¿ -->
    <div id="transformerRegressorTemplate" class="model-config-template">
        <div class="alert alert-light border border-warning p-3 rounded mb-4">
            <div class="d-flex align-items-start">
                <div class="me-3" style="font-size: 2rem;">âš¡</div>
                <div class="flex-grow-1">
                    <h6 class="alert-heading text-warning mb-2">
                        <i class="fas fa-info-circle"></i> æ¨¡å‹è¯´æ˜
                    </h6>
                    <ul class="small mb-0">
                        <li><strong>ç±»å‹:</strong> Transformer Encoder å›å½’å™¨</li>
                        <li><strong>é€‚ç”¨åœºæ™¯:</strong> é•¿åºåˆ—ã€å¤šå·¥å†µçš„RULé¢„æµ‹ï¼Œä¾èµ–è‡ªæ³¨æ„åŠ›æ•æ‰å…¨å±€ä¾èµ–</li>
                        <li><strong>ä¼˜åŠ¿:</strong> å¤šå¤´æ³¨æ„åŠ›å¯å¹¶è¡Œå»ºæ¨¡è¿œè·ç¦»ä¾èµ–ï¼Œå¯é…ç½®å±‚æ•°/å¤´æ•°/æ± åŒ–ç­–ç•¥</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="param-section">
            <h6><i class="fas fa-bolt"></i> Transformer ç½‘ç»œå‚æ•°</h6>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">æ¨¡å‹ç»´åº¦</label>
                    <input type="number" class="form-control" id="embedDim" name="embedDim" value="128" min="32" max="512" step="16" aria-label="æ¨¡å‹ç»´åº¦">
                    <div class="form-text">è¾“å…¥ç‰¹å¾æŠ•å½±åˆ°çš„ç»´åº¦ï¼Œéœ€èƒ½è¢«æ³¨æ„åŠ›å¤´æ•°æ•´é™¤</div>
                </div>
                <div class="param-item">
                    <label class="form-label">æ³¨æ„åŠ›å¤´æ•°</label>
                    <input type="number" class="form-control" id="numHeads" name="numHeads" value="4" min="1" max="16" aria-label="æ³¨æ„åŠ›å¤´æ•°">
                    <div class="form-text">å¤šå¤´è‡ªæ³¨æ„åŠ›çš„å¤´æ•°é‡ï¼Œå½±å“è¡¨è¾¾èƒ½åŠ›ä¸è®¡ç®—é‡</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">Encoderå±‚æ•°</label>
                    <input type="number" class="form-control" id="numLayers" name="numLayers" value="3" min="1" max="6" aria-label="Encoderå±‚æ•°">
                    <div class="form-text">å †å çš„è‡ªæ³¨æ„åŠ›å±‚æ•°é‡ï¼Œæ›´å¤šå±‚èƒ½å»ºæ¨¡æ›´å¤æ‚æ¨¡å¼</div>
                </div>
                <div class="param-item">
                    <label class="form-label">å‰é¦ˆå±‚å®½åº¦</label>
                    <input type="number" class="form-control" id="ffnDim" name="ffnDim" value="256" min="64" max="1024" step="32" aria-label="å‰é¦ˆå±‚å®½åº¦">
                    <div class="form-text">FFNéšè—å±‚ç»´åº¦ï¼Œé€šå¸¸ä¸ºembedç»´åº¦çš„2-4å€</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">Dropoutç‡</label>
                    <input type="number" class="form-control" id="transformerDropout" name="dropout" value="0.1" step="0.05" min="0" max="0.5" aria-label="Dropoutç‡">
                    <div class="form-text">åº”ç”¨åœ¨æ³¨æ„åŠ›å’Œå‰é¦ˆå±‚çš„Dropoutæ¯”ä¾‹</div>
                </div>
                <div class="param-item">
                    <label class="form-label">æ¿€æ´»å‡½æ•°</label>
                    <select class="form-select" id="transformerActivation" name="activation" aria-label="æ¿€æ´»å‡½æ•°">
                        <option value="gelu" selected>GELU</option>
                        <option value="relu">ReLU</option>
                        <option value="tanh">Tanh</option>
                        <option value="leakyrelu">LeakyReLU</option>
                    </select>
                    <div class="form-text">å‰é¦ˆç½‘ç»œä¸­çš„æ¿€æ´»å‡½æ•°</div>
                </div>
            </div>
            <div class="param-row">
                <div class="param-item">
                    <label class="form-label">æ± åŒ–ç­–ç•¥</label>
                    <select class="form-select" id="transformerPooling" name="pooling" aria-label="æ± åŒ–ç­–ç•¥">
                        <option value="avg" selected>å…¨å±€å¹³å‡</option>
                        <option value="max">å…¨å±€æœ€å¤§</option>
                        <option value="last">æœ€åæ—¶é—´æ­¥</option>
                    </select>
                    <div class="form-text">ç¼–ç ååºåˆ—å¦‚ä½•å‹ç¼©ä¸ºå•ä¸ªç‰¹å¾å‘é‡</div>
                </div>
                <div class="param-item">
                    <label class="form-label">ä½ç½®ç¼–ç </label>
                    <select class="form-select" id="usePositionalEncoding" name="usePositionalEncoding" aria-label="ä½ç½®ç¼–ç ">
                        <option value="true" selected>å¯ç”¨</option>
                        <option value="false">ç¦ç”¨</option>
                    </select>
                    <div class="form-text">æ˜¯å¦ä½¿ç”¨å¯å­¦ä¹ çš„ä½ç½®ç¼–ç æ³¨å…¥åºåˆ—é¡ºåºä¿¡æ¯</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// å…¨å±€å˜é‡
let trainFiles = [];
let testFiles = [];
let selectedModelType = 'bilstm_gru_regressor';
let selectedConditions = {}; // {key: [value1, value2, ...]}

function toBooleanValue(value, defaultValue = false) {
    if (value === null || value === undefined || value === '') {
        return defaultValue;
    }
    if (typeof value === 'boolean') {
        return value;
    }
    if (typeof value === 'number') {
        return value !== 0;
    }
    return String(value).trim().toLowerCase() === 'true';
}

function parseIntListInput(value, fallback = []) {
    if (value === null || value === undefined) {
        return [...fallback];
    }
    if (Array.isArray(value)) {
        const parsed = value
            .map(item => parseInt(item, 10))
            .filter(num => !Number.isNaN(num));
        return parsed.length ? parsed : [...fallback];
    }
    const text = String(value).replace(/ï¼Œ/g, ',');
    const parsed = text
        .split(/[;,]/)
        .map(item => item.trim())
        .filter(item => item !== '')
        .map(item => parseInt(item, 10))
        .filter(num => !Number.isNaN(num));
    return parsed.length ? parsed : [...fallback];
}

function normalizeDeviceTarget(value) {
    const normalized = (value || 'CPU').toString().trim().toLowerCase();
    if (normalized === 'gpu') {
        return 'GPU';
    }
    if (normalized === 'ascend' || normalized === 'npu' || normalized === 'atlas') {
        return 'Ascend';
    }
    return 'CPU';
}

// æ¨¡å‹ç±»å‹é…ç½®
const modelTypeConfigs = {
    bilstm_gru_regressor: {
        name: 'BiLSTM/GRU å›å½’å™¨',
        templateId: 'bilstmGruRegressorTemplate',
    },
    cnn_1d_regressor: {
        name: '1D-CNN å›å½’å™¨',
        templateId: 'cnn1dRegressorTemplate',
    },
    transformer_encoder_regressor: {
        name: 'Transformer Encoder å›å½’å™¨',
        templateId: 'transformerRegressorTemplate',
    }
};

// é¡µé¢åˆå§‹åŒ–ï¼ˆå®Œæ•´ç‰ˆï¼ŒåŒ…å«æ•°æ®é›†é…ç½®ï¼‰
document.addEventListener('DOMContentLoaded', async function() {
    console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ¨¡å‹é…ç½®');
    
    try {
        // åˆå§‹åŒ–æ¨¡å‹ç±»å‹ï¼ˆé»˜è®¤é€‰æ‹©BiLSTM/GRUå›å½’å™¨ï¼‰
        const defaultModelType = document.getElementById('modelType')?.value || 'bilstm_gru_regressor';
        switchModelType(defaultModelType);
        
        // ä¸ºæ¨¡å‹ç±»å‹é€‰æ‹©æ·»åŠ å˜åŒ–ç›‘å¬
        const modelTypeSelect = document.getElementById('modelType');
        if (modelTypeSelect) {
            modelTypeSelect.addEventListener('change', function() {
                switchModelType(this.value);
            });
        }
        
        // ä¸ºåŠ è½½é»˜è®¤é…ç½®æŒ‰é’®æ·»åŠ åŠŸèƒ½
        document.getElementById('loadDefaultsBtn')?.addEventListener('click', function() {
            loadDefaultConfiguration();
        });
        
        // åŠ è½½å·¥å†µé€‰é¡¹
        await loadConditionKeys();
        
    } catch (error) {
        console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
        showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
    }
});

// åŠ è½½å·¥å†µkeyåˆ—è¡¨
async function loadConditionKeys() {
    const area = document.getElementById('conditionSelectionArea');
    if (!area) {
        console.error('âŒ æœªæ‰¾åˆ°conditionSelectionAreaå…ƒç´ ');
        return;
    }
    
    try {
        area.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div><span class="ms-2 text-muted">åŠ è½½å·¥å†µé€‰é¡¹...</span></div>';
        
        const response = await fetch('/rul_prediction/api/condition_keys');
        const result = await response.json();
        
        if (result.success) {
            if (result.keys && result.keys.length > 0) {
                console.log(`âœ… æ‰¾åˆ° ${result.keys.length} ä¸ªå·¥å†µkey:`, result.keys);
                renderConditionKeys(result.keys);
                // åŠ è½½å®Œå·¥å†µkeyåï¼ŒåŠ è½½æ‰€æœ‰æ•°æ®æ–‡ä»¶
                setTimeout(() => {
                    loadAllFiles();
                }, 500);
            } else {
                console.warn('âš ï¸ æ²¡æœ‰æ‰¾åˆ°å·¥å†µkeyï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æ–‡ä»¶');
                area.innerHTML = '<div class="alert alert-info mb-0"><i class="fas fa-info-circle me-2"></i>æœªæ‰¾åˆ°å·¥å†µæ•°æ®ï¼Œå°†æ˜¾ç¤ºæ‰€æœ‰æ•°æ®æ–‡ä»¶ã€‚å¦‚éœ€ä½¿ç”¨å·¥å†µç­›é€‰ï¼Œè¯·å…ˆè¿›è¡Œæ•°æ®æ ‡æ³¨ã€‚</div>';
                setTimeout(() => {
                    loadAllFiles();
                }, 500);
            }
        } else {
            throw new Error(result.error || 'æœªçŸ¥é”™è¯¯');
        }
    } catch (error) {
        console.error('âŒ åŠ è½½å·¥å†µkeyå¤±è´¥:', error);
        area.innerHTML = '<div class="alert alert-danger mb-0">åŠ è½½å·¥å†µé€‰é¡¹å¤±è´¥: ' + error.message + '</div>';
    }
}

// æ¸²æŸ“å·¥å†µkeyé€‰æ‹©åŒºåŸŸ
function renderConditionKeys(keys) {
    const area = document.getElementById('conditionSelectionArea');
    if (!area) return;
    
    let html = '<div class="row g-3">';
    
    keys.forEach(key => {
        const valuesId = `conditionValues_${key}`;
        html += `
            <div class="col-md-6">
                <div class="card border">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-tag me-2 text-primary"></i>${key}
                        </h6>
                        <div id="${valuesId}" class="mt-2">
                            <div class="text-center py-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="loadConditionValues('${key}')">
                                    <i class="fas fa-chevron-down me-1"></i>å±•å¼€é€‰é¡¹
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    area.innerHTML = html;
}

// åŠ è½½æŒ‡å®škeyçš„valueåˆ—è¡¨
async function loadConditionValues(key) {
    const container = document.getElementById(`conditionValues_${key}`);
    if (!container) return;
    
    try {
        container.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch(`/rul_prediction/api/condition_values?key=${encodeURIComponent(key)}`);
        const result = await response.json();
        
        if (result.success && result.values && result.values.length > 0) {
            renderConditionValues(key, result.values);
        } else {
            container.innerHTML = '<div class="text-muted small">æš‚æ— é€‰é¡¹</div>';
        }
    } catch (error) {
        console.error(`åŠ è½½å·¥å†µvalueå¤±è´¥ (${key}):`, error);
        container.innerHTML = '<div class="text-danger small">åŠ è½½å¤±è´¥</div>';
    }
}

// æ¸²æŸ“å·¥å†µvalueé€‰æ‹©åŒºåŸŸ
function renderConditionValues(key, values) {
    const container = document.getElementById(`conditionValues_${key}`);
    if (!container) return;
    
    let html = '<div class="d-flex flex-wrap gap-2">';
    
    values.forEach(value => {
        const isSelected = selectedConditions[key] && selectedConditions[key].includes(value);
        const btnId = `conditionBtn_${key}_${value}`;
        html += `
            <button type="button" 
                    class="btn btn-sm ${isSelected ? 'btn-primary' : 'btn-outline-primary'}" 
                    onclick="toggleConditionValue('${key}', '${value}')"
                    id="${btnId}">
                ${value}
                ${isSelected ? ' <i class="fas fa-check"></i>' : ''}
            </button>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// åˆ‡æ¢å·¥å†µvalueé€‰æ‹©
function toggleConditionValue(key, value) {
    if (!selectedConditions[key]) {
        selectedConditions[key] = [];
    }
    
    const index = selectedConditions[key].indexOf(value);
    if (index > -1) {
        selectedConditions[key].splice(index, 1);
    } else {
        selectedConditions[key].push(value);
    }
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    const btnId = `conditionBtn_${key}_${value}`;
    const btn = document.getElementById(btnId);
    if (btn) {
        if (selectedConditions[key].includes(value)) {
            btn.className = 'btn btn-sm btn-primary';
            btn.innerHTML = `${value} <i class="fas fa-check"></i>`;
        } else {
            btn.className = 'btn btn-sm btn-outline-primary';
            btn.innerHTML = value;
        }
    }
    
    // å¦‚æœè¯¥keyæ²¡æœ‰é€‰ä¸­ä»»ä½•valueï¼Œä»selectedConditionsä¸­ç§»é™¤
    if (selectedConditions[key].length === 0) {
        delete selectedConditions[key];
    }
    
    // é‡æ–°ç­›é€‰æ–‡ä»¶ï¼ˆå¦‚æœæœ‰é€‰æ‹©å·¥å†µï¼‰æˆ–é‡æ–°åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆå¦‚æœæ²¡æœ‰é€‰æ‹©å·¥å†µï¼‰
    const hasConditions = Object.keys(selectedConditions).length > 0 && 
                          Object.values(selectedConditions).some(v => v.length > 0);
    
    if (hasConditions) {
        filterFiles();
    } else {
        loadAllFiles();
    }
}

// åŠ è½½æ‰€æœ‰æ•°æ®æ–‡ä»¶ï¼ˆä¸ç­›é€‰ï¼‰
async function loadAllFiles() {
    const area = document.getElementById('trainFileSelectionArea');
    const list = document.getElementById('trainFileList');
    const countSpan = document.getElementById('trainFileCount');
    const testArea = document.getElementById('testFileSelectionArea');
    const testList = document.getElementById('testFileList');
    const testCountSpan = document.getElementById('testFileCount');
    
    if (!area || !list) {
        console.error('âŒ æœªæ‰¾åˆ°æ–‡ä»¶é€‰æ‹©åŒºåŸŸå…ƒç´ ');
        return;
    }
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        if (testList) testList.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        // å¦‚æœæ²¡æœ‰é€‰æ‹©å·¥å†µï¼Œç›´æ¥åŠ è½½æ‰€æœ‰æ–‡ä»¶
        const hasConditions = Object.keys(selectedConditions).length > 0 && 
                              Object.values(selectedConditions).some(v => v.length > 0);
        
        if (!hasConditions) {
            // åŠ è½½æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸ç­›é€‰ï¼‰
            const response = await fetch('/rul_prediction/api/processed_data');
        const result = await response.json();
        
        if (result.success) {
                console.log(`âœ… æˆåŠŸåŠ è½½ ${result.files.length} ä¸ªæ–‡ä»¶`);
                
            trainFiles = result.files || [];
                testFiles = result.files || [];
                
                console.log(`è®­ç»ƒé›†æ–‡ä»¶: ${trainFiles.length} ä¸ª, æµ‹è¯•é›†æ–‡ä»¶: ${testFiles.length} ä¸ª`);
                
                if (trainFiles.length > 0) {
                    renderFileList(list, trainFiles, 'train');
                    area.style.display = 'block';
                    if (countSpan) countSpan.textContent = trainFiles.length;
        } else {
                    list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶</div>';
                    area.style.display = 'block';
                    if (countSpan) countSpan.textContent = '0';
                }
                
                // æ˜¾ç¤ºæµ‹è¯•é›†
                if (testFiles.length > 0 && testList) {
                    renderFileList(testList, testFiles, 'test');
                    if (testArea) testArea.style.display = 'block';
                    if (testCountSpan) testCountSpan.textContent = testFiles.length;
                } else if (testList) {
                    testList.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰å¯ç”¨çš„æ•°æ®æ–‡ä»¶</div>';
                    if (testArea) testArea.style.display = 'block';
                    if (testCountSpan) testCountSpan.textContent = '0';
                }
            } else {
                throw new Error(result.error || 'åŠ è½½å¤±è´¥');
            }
        } else {
            // æœ‰å·¥å†µé€‰æ‹©ï¼Œè¿›è¡Œç­›é€‰
            await filterTrainFiles();
            await filterValFiles();
            await filterTestFiles();
        }
    } catch (error) {
        console.error('åŠ è½½æ•°æ®æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
    }
}

// ç­›é€‰æ–‡ä»¶
async function filterFiles() {
    // ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶
    await filterTrainFiles();
    
    // ç­›é€‰éªŒè¯é›†æ–‡ä»¶ï¼ˆä½¿ç”¨å’Œè®­ç»ƒé›†ç›¸åŒçš„æ–‡ä»¶æ± ï¼‰
    await filterValFiles();
    
    // è‡ªåŠ¨ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶
    await filterTestFiles();
}

// ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶
async function filterTrainFiles() {
    const area = document.getElementById('trainFileSelectionArea');
    const list = document.getElementById('trainFileList');
    const countSpan = document.getElementById('trainFileCount');
    
    if (!area || !list) return;
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch('/rul_prediction/api/filter_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conditions: selectedConditions,
                file_type: 'train'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            trainFiles = result.files || [];
            
            if (trainFiles.length > 0) {
                renderFileList(list, trainFiles, 'train');
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = trainFiles.length;
            } else {
                list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = '0';
            }
        } else {
            list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (error) {
        console.error('ç­›é€‰è®­ç»ƒé›†æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + error.message + '</div>';
    }
}

// ç­›é€‰éªŒè¯é›†æ–‡ä»¶ï¼ˆä½¿ç”¨å’Œè®­ç»ƒé›†ç›¸åŒçš„æ–‡ä»¶æ± ï¼‰
async function filterValFiles() {
    const area = document.getElementById('valFileSelectionArea');
    const list = document.getElementById('valFileList');
    const countSpan = document.getElementById('valFileCount');
    
    if (!area || !list) return;
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch('/rul_prediction/api/filter_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conditions: selectedConditions,
                file_type: 'train'  // éªŒè¯é›†å’Œè®­ç»ƒé›†ä½¿ç”¨ç›¸åŒçš„æ–‡ä»¶æ± 
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            valFiles = result.files || [];
            
            if (valFiles.length > 0) {
                renderFileList(list, valFiles, 'val');
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = valFiles.length;
            } else {
                list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = '0';
            }
        } else {
            list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (error) {
        console.error('ç­›é€‰éªŒè¯é›†æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + error.message + '</div>';
    }
}

// ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶
async function filterTestFiles() {
    const area = document.getElementById('testFileSelectionArea');
    const list = document.getElementById('testFileList');
    const countSpan = document.getElementById('testFileCount');
    
    if (!area || !list) return;
    
    try {
        list.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary"></div></div>';
        
        const response = await fetch('/rul_prediction/api/filter_files', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                conditions: selectedConditions,
                file_type: 'test'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            testFiles = result.files || [];
            
            if (testFiles.length > 0) {
                renderFileList(list, testFiles, 'test');
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = testFiles.length;
        } else {
                list.innerHTML = '<div class="text-muted text-center py-3">æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–‡ä»¶</div>';
                area.style.display = 'block';
                if (countSpan) countSpan.textContent = '0';
            }
        } else {
            list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯') + '</div>';
        }
    } catch (error) {
        console.error('ç­›é€‰æµ‹è¯•é›†æ–‡ä»¶å¤±è´¥:', error);
        list.innerHTML = '<div class="alert alert-danger mb-0">ç­›é€‰å¤±è´¥: ' + error.message + '</div>';
    }
}

// æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
function renderFileList(container, files, type) {
    if (!container) return;
    
    if (files.length === 0) {
        container.innerHTML = '<div class="text-muted text-center py-3">æš‚æ— æ–‡ä»¶</div>';
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm table-hover mb-0">';
    html += '<thead class="table-light"><tr>';
    html += '<th style="width: 40px;"><input type="checkbox" class="form-check-input" onchange="toggleAllFiles(this, \'' + type + '\')"></th>';
    html += '<th>æ–‡ä»¶å</th>';
    
    // æ·»åŠ å·¥å†µåˆ—
    const allKeys = Object.keys(selectedConditions);
    allKeys.forEach(key => {
        html += `<th>${key}</th>`;
    });
    
    html += '<th>å¤§å°</th>';
    html += '</tr></thead><tbody>';
    
    files.forEach((file, index) => {
        const conditions = file.conditions || {};
        html += '<tr>';
        html += `<td><input type="checkbox" class="form-check-input file-checkbox" data-filename="${file.filename || file.name}" data-type="${type}"></td>`;
        html += `<td><small>${file.display_name || file.filename || file.name}</small></td>`;
        
        // æ·»åŠ å·¥å†µå€¼
        allKeys.forEach(key => {
            const value = conditions[key] || '';
            html += `<td><small>${value || '<span class="text-muted">-</span>'}</small></td>`;
        });
        
        html += `<td><small>${formatFileSize(file.size || 0)}</small></td>`;
        html += '</tr>';
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

// æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// å…¨é€‰/å–æ¶ˆå…¨é€‰æ–‡ä»¶
function toggleAllFiles(checkbox, type) {
    const checkboxes = document.querySelectorAll(`.file-checkbox[data-type="${type}"]`);
    checkboxes.forEach(cb => cb.checked = checkbox.checked);
}

// å…¨é€‰è®­ç»ƒé›†æ–‡ä»¶
function selectAllTrainFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="train"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// å–æ¶ˆå…¨é€‰è®­ç»ƒé›†æ–‡ä»¶
function deselectAllTrainFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="train"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// å…¨é€‰æµ‹è¯•é›†æ–‡ä»¶
function selectAllTestFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="test"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// å–æ¶ˆå…¨é€‰æµ‹è¯•é›†æ–‡ä»¶
function deselectAllTestFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="test"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// å…¨é€‰éªŒè¯é›†æ–‡ä»¶
function selectAllValFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="val"]');
    checkboxes.forEach(cb => cb.checked = true);
}

// å–æ¶ˆå…¨é€‰éªŒè¯é›†æ–‡ä»¶
function deselectAllValFiles() {
    const checkboxes = document.querySelectorAll('.file-checkbox[data-type="val"]');
    checkboxes.forEach(cb => cb.checked = false);
}

// è·å–é€‰ä¸­çš„æ–‡ä»¶
function getSelectedFiles(type) {
    const checkboxes = document.querySelectorAll(`.file-checkbox[data-type="${type}"]:checked`);
    return Array.from(checkboxes).map(cb => cb.getAttribute('data-filename'));
}

// åˆ‡æ¢æ¨¡å‹ç±»å‹
function switchModelType(modelType) {
    const container = document.getElementById('dynamicModelConfig');
    const networkParamsContent = document.getElementById('networkParamsContent');
    
    if (!modelType) {
        if (container) {
            container.innerHTML = '<div class="alert alert-info mb-0">è¯·é€‰æ‹©æ¨¡å‹ç±»å‹</div>';
        }
        if (networkParamsContent) {
            networkParamsContent.innerHTML = '<div class="alert alert-info mb-3"><small><i class="fas fa-info-circle me-2"></i>è¯·å…ˆé€‰æ‹©æ¨¡å‹ç±»å‹ï¼Œç½‘ç»œå‚æ•°å°†æ ¹æ®æ¨¡å‹ç±»å‹è‡ªåŠ¨æ˜¾ç¤º</small></div>';
        }
        return;
    }
    
    selectedModelType = modelType;
    
    const config = modelTypeConfigs[selectedModelType];
    if (!config) {
        console.error('æœªçŸ¥çš„æ¨¡å‹ç±»å‹:', selectedModelType);
        return;
    }
    
    if (!container || !networkParamsContent) {
        console.error('æ‰¾ä¸åˆ°å¿…è¦çš„å®¹å™¨å…ƒç´ ');
        return;
    }
    
    const template = document.getElementById(config.templateId);
    if (!template) {
        console.error(`æ‰¾ä¸åˆ°æ¨¡æ¿: ${config.templateId}`);
        return;
    }
    
    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    networkParamsContent.innerHTML = '';
    
    // å¤åˆ¶æ¨¡æ¿å†…å®¹
    const templateContent = template.cloneNode(true);
    templateContent.style.display = 'block';
    templateContent.id = ''; // ç§»é™¤IDé¿å…å†²çª
    
    // æå–æ¨¡å‹è¯´æ˜å’Œç½‘ç»œå‚æ•°éƒ¨åˆ†
    const modelInfo = templateContent.querySelector('.alert');
    const networkParamsSection = templateContent.querySelector('.param-section');
    
    // å°†æ¨¡å‹è¯´æ˜æ·»åŠ åˆ°æ¨¡å‹é…ç½®åŒºåŸŸ
    if (modelInfo) {
        container.appendChild(modelInfo.cloneNode(true));
    }
    
    // å°†ç½‘ç»œå‚æ•°æ·»åŠ åˆ°ç½‘ç»œå‚æ•°éƒ¨åˆ†
    if (networkParamsSection) {
        // åªæå– param-section å†…éƒ¨çš„å†…å®¹ï¼ˆparam-row ç­‰ï¼‰ï¼Œè€Œä¸æ˜¯æ•´ä¸ª param-section å®¹å™¨
        const clonedSection = networkParamsSection.cloneNode(true);
        const titleElement = clonedSection.querySelector('h6');
        if (titleElement) {
            titleElement.remove();
        }
        
        // ç¡®ä¿å…‹éš†å…ƒç´ ä¸­çš„IDå”¯ä¸€æ€§
        const timestamp = Date.now();
        const randomSuffix = Math.random().toString(36).substr(2, 9);
        
        // å¤„ç†æœ‰IDçš„å…ƒç´ ï¼ˆåªä¿®æ”¹IDï¼Œä¿ç•™nameå±æ€§ï¼‰
        const elementsWithId = clonedSection.querySelectorAll('[id]');
        elementsWithId.forEach((element, index) => {
            if (element.id) {
                const oldId = element.id;
                const newId = `${oldId}-dynamic-${timestamp}-${randomSuffix}-${index}`;
                element.id = newId;
                
                // ç¡®ä¿nameå±æ€§è¢«ä¿ç•™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                // nameå±æ€§ä¸åº”è¯¥è¢«ä¿®æ”¹ï¼Œè¿™æ ·FormDataæ‰èƒ½æ­£ç¡®æ”¶é›†å€¼
                if (!element.hasAttribute('name') && element.tagName === 'SELECT') {
                    // å¦‚æœselectå…ƒç´ æ²¡æœ‰nameå±æ€§ï¼Œä½¿ç”¨åŸå§‹IDä½œä¸ºname
                    element.setAttribute('name', oldId);
                }
                
                // æ›´æ–°å¯¹åº”çš„label[for]å±æ€§
                const relatedLabel = clonedSection.querySelector(`label[for="${oldId}"]`);
                if (relatedLabel) {
                    relatedLabel.setAttribute('for', newId);
                }
            }
        });
        
        // åªæ·»åŠ  param-section å†…éƒ¨çš„æ‰€æœ‰å­èŠ‚ç‚¹ï¼Œè€Œä¸æ˜¯æ•´ä¸ª param-section å®¹å™¨
        while (clonedSection.firstChild) {
            networkParamsContent.appendChild(clonedSection.firstChild);
        }
    }
    
    // æ›´æ–°æ¨¡å‹é…ç½®æ ‡é¢˜
    const titleElement = document.getElementById('modelConfigTitle');
    if (titleElement) {
        titleElement.textContent = config.name + ' - æ¨¡å‹è¯´æ˜';
    }
}

// åŠ è½½é»˜è®¤é…ç½®
function loadDefaultConfiguration() {
    if (!selectedModelType) {
        alert('è¯·å…ˆé€‰æ‹©æ¨¡å‹ç±»å‹');
        return;
    }

    const setValue = (id, value) => {
        const el = document.getElementById(id);
        if (el) {
            el.value = value;
            return;
        }
        const networkParamsContent = document.getElementById('networkParamsContent');
        if (networkParamsContent) {
            const byName = networkParamsContent.querySelector(`[name="${id}"]`) ||
                          networkParamsContent.querySelector(`[id*="${id}"]`);
            if (byName) {
                byName.value = value;
            }
        }
    };

    // é€šç”¨è¶…å‚æ•°
    setValue('sequenceLength', '50');
    setValue('stride', '1');
    setValue('learningRate', '0.001');
    setValue('weightDecay', '0.0001');
    setValue('lossType', 'mse');
    setValue('numEpochs', '50');
    setValue('batchSize', '32');
    setValue('patience', '10');
    setValue('earlyStopMode', 'loss');
    setValue('clipGradNorm', '5.0');
    setValue('randomSeed', '42');
    setValue('device', 'gpu');

    if (selectedModelType === 'bilstm_gru_regressor') {
        setValue('rnnType', 'lstm');
        setValue('hiddenUnits', '128');
        setValue('numLayers', '2');
        setValue('dropout', '0.3');
        setValue('activation', 'relu');
        setValue('bidirectional', 'true');
        setValue('useAttention', 'true');
        setValue('useLayerNorm', 'true');
    } else if (selectedModelType === 'cnn_1d_regressor') {
        setValue('convChannels', '64,128,256');
        setValue('kernelSizes', '7,5,3');
        setValue('dropout', '0.3');
        setValue('activation', 'relu');
        setValue('pooling', 'avg');
        setValue('useBatchNorm', 'true');
        setValue('fcUnits', '256');
    } else if (selectedModelType === 'transformer_encoder_regressor') {
        setValue('embedDim', '128');
        setValue('numHeads', '4');
        setValue('numLayers', '3');
        setValue('ffnDim', '256');
        setValue('dropout', '0.1');
        setValue('activation', 'gelu');
        setValue('pooling', 'avg');
        setValue('usePositionalEncoding', 'true');
    }
    
    alert('é»˜è®¤é…ç½®å·²åŠ è½½');
}

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
    alert(message);
}

// è¡¨å•æäº¤å¤„ç†
document.getElementById('zeroCodeForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    try {
        // æ”¶é›†è¡¨å•æ•°æ®
        const formData = new FormData(this);
        const trainingData = {};
        
        // è·å–æ¨¡å‹ç±»å‹
        const modelType = document.getElementById('modelType')?.value;
        trainingData.model_type = modelType;
        trainingData.module = 'rul_prediction';  // æ·»åŠ moduleå­—æ®µ
        
        // éªŒè¯è®­ç»ƒé›†æ–‡ä»¶
    const selectedTrainFiles = getSelectedFiles('train');
        if (!selectedTrainFiles || selectedTrainFiles.length === 0) {
            showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªè®­ç»ƒé›†æ–‡ä»¶');
        return;
    }
    
        // éªŒè¯éªŒè¯é›†æ–‡ä»¶
        const selectedValFiles = getSelectedFiles('val');
        if (!selectedValFiles || selectedValFiles.length === 0) {
            showError('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªéªŒè¯é›†æ–‡ä»¶');
            return;
        }
        
        // æ£€æŸ¥è®­ç»ƒé›†å’ŒéªŒè¯é›†æ˜¯å¦æœ‰é‡å 
        const overlap = selectedTrainFiles.filter(f => selectedValFiles.includes(f));
        if (overlap.length > 0) {
            showError('è®­ç»ƒé›†å’ŒéªŒè¯é›†ä¸èƒ½æœ‰é‡å çš„æ–‡ä»¶ï¼\né‡å æ–‡ä»¶ï¼š' + overlap.join(', '));
            return;
        }
    
        // è·å–å·¥å†µè®¾ç½®ï¼ˆä»selectedConditionsæ„å»ºconditionsConfigï¼‰
        const conditionsConfig = [];
        Object.keys(selectedConditions).forEach(key => {
            const values = selectedConditions[key].map(v => {
                // å°è¯•è½¬æ¢ä¸ºæ•°å­—ï¼Œå¦‚æœå¤±è´¥åˆ™ä¿æŒå­—ç¬¦ä¸²
                const num = parseFloat(v);
                return isNaN(num) ? v : num;
            });
            if (values.length > 0) {
                conditionsConfig.push({ name: key, values: values });
            }
        });
        
        trainingData.conditions = conditionsConfig;
        trainingData.num_conditions = conditionsConfig.length;
        
        // RULé¢„æµ‹ä½¿ç”¨æ–‡ä»¶ååˆ—è¡¨
        trainingData.train_files = selectedTrainFiles;
        trainingData.validation_files = selectedValFiles;  // æ·»åŠ éªŒè¯é›†æ–‡ä»¶
        
        // æ”¶é›†æµ‹è¯•é›†æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
        const selectedTestFiles = getSelectedFiles('test');
        if (selectedTestFiles && selectedTestFiles.length > 0) {
            trainingData.test_files = selectedTestFiles;
        }
        
        // è·å–åºåˆ—é•¿åº¦å’Œæ­¥é•¿
        trainingData.sequence_length = parseInt(formData.get('sequenceLength') || '50');
        trainingData.stride = parseInt(formData.get('stride') || '1');
        
        // ä¸å†ä½¿ç”¨validation_splitï¼Œæ”¹ç”¨validation_files
        trainingData.random_seed = parseInt(formData.get('randomSeed') || '42');
        trainingData.dataset_mode = 'file_based_validation'; // ä½¿ç”¨æ–‡ä»¶çº§éªŒè¯é›†æ¨¡å¼
        
        // è·å–è®­ç»ƒå‚æ•°
        trainingData.epochs = parseInt(formData.get('numEpochs') || '50');
        trainingData.batch_size = parseInt(formData.get('batchSize') || '32');
        trainingData.learning_rate = parseFloat(formData.get('learningRate') || '0.001');
        trainingData.weight_decay = parseFloat(formData.get('weightDecay') || '0.0001');
        trainingData.clip_grad_norm = parseFloat(formData.get('clipGradNorm') || '5.0');
        trainingData.patience = parseInt(formData.get('patience') || '10');
        const normalizedDevice = normalizeDeviceTarget(formData.get('device') || 'GPU');
        trainingData.device_target = normalizedDevice;
        trainingData.device = normalizedDevice;
        
        // è·å–æŸå¤±å‡½æ•°ç±»å‹å’Œæ—©åœæ¨¡å¼ï¼ˆRULé¢„æµ‹ç‰¹æœ‰ï¼‰
        trainingData.loss_type = formData.get('lossType') || 'mse';
        trainingData.early_stop_mode = formData.get('earlyStopMode') || 'loss';
        
        // è·å–æ¨¡å‹ç‰¹å®šå‚æ•°
        if (modelType === 'bilstm_gru_regressor') {
            // ä»åŠ¨æ€æ’å…¥çš„å®¹å™¨ä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆå› ä¸ºIDå¯èƒ½è¢«ä¿®æ”¹äº†ï¼‰
            const networkParamsContent = document.getElementById('networkParamsContent');
            
            // è¾…åŠ©å‡½æ•°ï¼šä»å®¹å™¨ä¸­æŸ¥æ‰¾å…ƒç´ ï¼ˆæ”¯æŒåŸå§‹IDæˆ–ä¿®æ”¹åçš„IDï¼‰
            const findElement = (id) => {
                // å…ˆå°è¯•ç›´æ¥æŸ¥æ‰¾
                let el = document.getElementById(id);
                if (el) return el;
                
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œä»networkParamsContentä¸­æŸ¥æ‰¾åŒ…å«è¯¥IDçš„å…ƒç´ 
                if (networkParamsContent) {
                    // æŸ¥æ‰¾IDä»¥åŸå§‹IDå¼€å¤´çš„å…ƒç´ 
                    const allElements = networkParamsContent.querySelectorAll(`[id^="${id}-"]`);
                    if (allElements.length > 0) {
                        return allElements[0];
                    }
                    // ä¹Ÿå°è¯•æŸ¥æ‰¾nameå±æ€§åŒ¹é…çš„å…ƒç´ 
                    const byName = networkParamsContent.querySelector(`[name="${id}"]`);
                    if (byName) return byName;
                }
                return null;
            };
            
            // æˆ–è€…æ›´ç®€å•çš„æ–¹æ³•ï¼šç›´æ¥ä»FormDataä¸­è·å–ï¼ˆå› ä¸ºnameå±æ€§æ²¡æœ‰è¢«ä¿®æ”¹ï¼‰
            const rnnTypeValue = formData.get('rnnType') || 'lstm';
            const hiddenUnitsValue = formData.get('hiddenUnits') ? parseInt(formData.get('hiddenUnits')) : 128;
            const numLayersValue = formData.get('numLayers') ? parseInt(formData.get('numLayers')) : 2;
            const dropoutValue = formData.get('dropout') ? parseFloat(formData.get('dropout')) : 0.3;
            const activationValue = formData.get('activation') || 'relu';
            const bidirectionalValue = toBooleanValue(formData.get('bidirectional'), true);
            const useAttentionValue = toBooleanValue(formData.get('useAttention'), true);
            
            // æ£€æŸ¥useLayerNormï¼šå…ˆä»FormDataè·å–ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»DOMå…ƒç´ è·å–
            let useLayerNormValue = formData.get('useLayerNorm');
            if (useLayerNormValue === null) {
                // FormDataä¸­æ²¡æœ‰ï¼Œå°è¯•ä»DOMå…ƒç´ è·å–ï¼ˆå¯èƒ½nameå±æ€§æœ‰é—®é¢˜ï¼‰
                const useLayerNormEl = networkParamsContent?.querySelector('[name="useLayerNorm"]') || 
                                      networkParamsContent?.querySelector('[id*="useLayerNorm"]');
                if (useLayerNormEl) {
                    useLayerNormValue = useLayerNormEl.value;
                    console.log('  è­¦å‘Šï¼šFormDataä¸­æ²¡æœ‰useLayerNormï¼Œä»DOMå…ƒç´ è·å–:', useLayerNormValue);
                } else {
                    useLayerNormValue = 'false'; // é»˜è®¤å€¼
                    console.log('  è­¦å‘Šï¼šæ‰¾ä¸åˆ°useLayerNormå…ƒç´ ï¼Œä½¿ç”¨é»˜è®¤å€¼false');
                }
            }
            useLayerNormValue = toBooleanValue(useLayerNormValue, true);
            
            trainingData.rnn_type = rnnTypeValue;
            trainingData.hidden_units = hiddenUnitsValue;
            trainingData.num_layers = numLayersValue;
            trainingData.dropout = dropoutValue;
            trainingData.activation = activationValue;
            trainingData.bidirectional = bidirectionalValue;
            trainingData.use_attention = useAttentionValue;
            trainingData.use_layer_norm = useLayerNormValue; // ç¡®ä¿è¿™ä¸ªå€¼è¢«è®¾ç½®
            
            // è°ƒè¯•æ—¥å¿—ï¼šæ£€æŸ¥æ¯ä¸ªå‚æ•°çš„å®é™…å€¼
            console.log('=== æ¨¡å‹å‚æ•°è°ƒè¯• ===');
            console.log('  FormDataä¸­çš„æ‰€æœ‰é”®:', Array.from(formData.keys()));
            console.log('  FormDataä¸­çš„rnnType:', formData.get('rnnType'), 'â†’ trainingData.rnn_type:', trainingData.rnn_type);
            console.log('  FormDataä¸­çš„hiddenUnits:', formData.get('hiddenUnits'), 'â†’ trainingData.hidden_units:', trainingData.hidden_units);
            console.log('  FormDataä¸­çš„bidirectional:', formData.get('bidirectional'), 'â†’ trainingData.bidirectional:', trainingData.bidirectional);
            console.log('  FormDataä¸­çš„useLayerNorm:', formData.get('useLayerNorm'), 'â†’ useLayerNormValue:', useLayerNormValue, 'â†’ trainingData.use_layer_norm:', trainingData.use_layer_norm);
            console.log('  FormDataä¸­çš„activation:', formData.get('activation'), 'â†’ trainingData.activation:', trainingData.activation);
            console.log('  FormDataä¸­çš„useAttention:', formData.get('useAttention'), 'â†’ trainingData.use_attention:', trainingData.use_attention);
            console.log('  æ‰€æœ‰æ¨¡å‹å‚æ•°:', {
                rnn_type: trainingData.rnn_type,
                hidden_units: trainingData.hidden_units,
                num_layers: trainingData.num_layers,
                dropout: trainingData.dropout,
                activation: trainingData.activation,
                bidirectional: trainingData.bidirectional,
                use_attention: trainingData.use_attention,
                use_layer_norm: trainingData.use_layer_norm
            });
            console.log('  å®Œæ•´çš„trainingDataå¯¹è±¡:', JSON.stringify(trainingData, null, 2));
        } else if (modelType === 'cnn_1d_regressor') {
            const convChannels = parseIntListInput(formData.get('convChannels'), [64, 128, 256]);
            const kernelSizes = parseIntListInput(formData.get('kernelSizes'), [7, 5, 3]);
            const dropoutValue = formData.get('dropout') ? parseFloat(formData.get('dropout')) : 0.3;
            const activationValue = formData.get('activation') || 'relu';
            const poolingRaw = (formData.get('pooling') || 'avg').toLowerCase();
            const poolingValue = ['avg', 'max', 'flatten'].includes(poolingRaw) ? poolingRaw : 'avg';
            const useBatchNormValue = toBooleanValue(formData.get('useBatchNorm'), true);
            const fcUnitsValue = formData.get('fcUnits') ? parseInt(formData.get('fcUnits'), 10) : 256;

            trainingData.conv_channels = convChannels;
            trainingData.kernel_sizes = kernelSizes;
            trainingData.dropout = dropoutValue;
            trainingData.activation = activationValue;
            trainingData.pooling = poolingValue;
            trainingData.use_batch_norm = useBatchNormValue;
            trainingData.fc_units = fcUnitsValue;

            console.log('=== CNN æ¨¡å‹å‚æ•°è°ƒè¯• ===');
            console.log('  conv_channels:', trainingData.conv_channels);
            console.log('  kernel_sizes:', trainingData.kernel_sizes);
            console.log('  pooling:', trainingData.pooling);
            console.log('  use_batch_norm:', trainingData.use_batch_norm);
            console.log('  fc_units:', trainingData.fc_units);
        } else if (modelType === 'transformer_encoder_regressor') {
            let embedDimValue = formData.get('embedDim') ? parseInt(formData.get('embedDim'), 10) : 128;
            let numHeadsValue = formData.get('numHeads') ? parseInt(formData.get('numHeads'), 10) : 4;
            let numLayersValue = formData.get('numLayers') ? parseInt(formData.get('numLayers'), 10) : 3;
            let ffnDimValue = formData.get('ffnDim') ? parseInt(formData.get('ffnDim'), 10) : 256;
            let dropoutValue = formData.get('dropout') ? parseFloat(formData.get('dropout')) : 0.1;
            const activationValue = formData.get('activation') || 'gelu';
            const poolingRaw = (formData.get('pooling') || 'avg').toLowerCase();
            const poolingValue = ['avg', 'max', 'last'].includes(poolingRaw) ? poolingRaw : 'avg';
            const usePositionalEncodingValue = toBooleanValue(formData.get('usePositionalEncoding'), true);

            if (Number.isNaN(embedDimValue) || embedDimValue <= 0) embedDimValue = 128;
            if (Number.isNaN(numHeadsValue) || numHeadsValue <= 0) numHeadsValue = 4;
            if (Number.isNaN(numLayersValue) || numLayersValue <= 0) numLayersValue = 3;
            if (Number.isNaN(ffnDimValue) || ffnDimValue <= 0) ffnDimValue = embedDimValue * 2;
            if (Number.isNaN(dropoutValue) || dropoutValue < 0) dropoutValue = 0;
            if (dropoutValue > 0.9) dropoutValue = 0.9;

            if (embedDimValue < numHeadsValue) {
                embedDimValue = numHeadsValue;
            }
            if (embedDimValue % numHeadsValue !== 0) {
                embedDimValue = Math.ceil(embedDimValue / numHeadsValue) * numHeadsValue;
            }
            if (ffnDimValue < embedDimValue * 2) {
                ffnDimValue = embedDimValue * 2;
            }

            trainingData.embed_dim = embedDimValue;
            trainingData.num_heads = numHeadsValue;
            trainingData.num_layers = numLayersValue;
            trainingData.ffn_dim = ffnDimValue;
            trainingData.dropout = dropoutValue;
            trainingData.activation = activationValue;
            trainingData.pooling = poolingValue;
            trainingData.use_positional_encoding = usePositionalEncodingValue;

            console.log('=== Transformer æ¨¡å‹å‚æ•°è°ƒè¯• ===');
            console.log('  embed_dim:', trainingData.embed_dim);
            console.log('  num_heads:', trainingData.num_heads);
            console.log('  num_layers:', trainingData.num_layers);
            console.log('  ffn_dim:', trainingData.ffn_dim);
            console.log('  dropout:', trainingData.dropout);
            console.log('  activation:', trainingData.activation);
            console.log('  pooling:', trainingData.pooling);
            console.log('  use_positional_encoding:', trainingData.use_positional_encoding);
        }
        
        console.log('æäº¤è®­ç»ƒæ•°æ®:', trainingData);
        console.log('æäº¤è®­ç»ƒæ•°æ®ä¸­çš„use_layer_norm:', trainingData.use_layer_norm);
        console.log('æäº¤è®­ç»ƒæ•°æ®çš„æ‰€æœ‰é”®:', Object.keys(trainingData));
        console.log('æäº¤è®­ç»ƒæ•°æ®JSON:', JSON.stringify(trainingData, null, 2));
    
    // æ˜¾ç¤ºè®­ç»ƒçŠ¶æ€
        const trainingStatusDiv = document.getElementById('trainingStatus');
        if (trainingStatusDiv) {
            trainingStatusDiv.style.display = 'block';
            trainingStatusDiv.innerHTML = `
                <div class="param-card">
                    <div class="param-card-header">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>è®­ç»ƒçŠ¶æ€</span>
                    </div>
                    <div class="param-card-body">
                        <div id="trainingStatusContent" class="training-status active">
                            <div class="d-flex align-items-center">
                                <div class="spinner-border spinner-border-sm me-2"></div>
                                <strong>æ­£åœ¨å¯åŠ¨è®­ç»ƒä»»åŠ¡...</strong>
                            </div>
                        </div>
                        <div id="trainingProgress" class="mt-3"></div>
                    </div>
                </div>
            `;
        }
        
        // ç¦ç”¨æäº¤æŒ‰é’®
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) submitBtn.disabled = true;
        
        const response = await fetch('/rul_prediction/api/train', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(trainingData)
        });
        
        const result = await response.json();
        
        const statusContent = document.getElementById('trainingStatusContent');
        if (!statusContent) return;
        
        if (result.success) {
            statusContent.innerHTML = `
                <div class="alert alert-success mb-0">
                    <h6><i class="fas fa-check-circle me-2"></i>è®­ç»ƒä»»åŠ¡å·²å¯åŠ¨</h6>
                    <p class="mb-0">ä»»åŠ¡ID: <code>${result.task_id}</code></p>
                    <p class="mb-0">æ­£åœ¨è·³è½¬åˆ°è®­ç»ƒè¿›åº¦é¡µé¢...</p>
                </div>
            `;
            
            // è·³è½¬åˆ°è®­ç»ƒè¿›åº¦é¡µé¢
            setTimeout(() => {
                window.location.href = `/rul_prediction/training_progress?task_id=${result.task_id}`;
            }, 1500);
        } else {
            statusContent.className = 'training-status error';
            statusContent.innerHTML = `<div class="alert alert-danger mb-0">è®­ç»ƒå¯åŠ¨å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
            if (submitBtn) submitBtn.disabled = false;
        }
    } catch (error) {
        console.error('å¯åŠ¨è®­ç»ƒå¤±è´¥:', error);
        const statusContent = document.getElementById('trainingStatusContent');
        if (statusContent) {
        statusContent.className = 'training-status error';
        statusContent.innerHTML = `<div class="alert alert-danger mb-0">è®­ç»ƒå¯åŠ¨å¤±è´¥: ${error.message}</div>`;
    }
        const submitBtn = document.querySelector('#zeroCodeForm button[type="submit"]');
        if (submitBtn) submitBtn.disabled = false;
}
});

// è½®è¯¢è®­ç»ƒçŠ¶æ€
async function pollTrainingStatus(taskId) {
    const maxAttempts = 1000; // æœ€å¤šè½®è¯¢1000æ¬¡
    let attempts = 0;
    
    const poll = async () => {
        if (attempts >= maxAttempts) {
            const statusContent = document.getElementById('trainingStatusContent');
            if (statusContent) {
                statusContent.innerHTML = '<div class="alert alert-warning mb-0">è®­ç»ƒçŠ¶æ€æŸ¥è¯¢è¶…æ—¶</div>';
            }
            const submitBtn = document.querySelector('#zeroCodeForm button[type="submit"]');
            if (submitBtn) submitBtn.disabled = false;
            return;
        }
        
        try {
            const response = await fetch(`/rul_prediction/api/task/${taskId}/status`);
            const result = await response.json();
            
            if (result.success && result.task) {
                const task = result.task;
                const status = task.status;
                const statusContent = document.getElementById('trainingStatusContent');
                const progressContent = document.getElementById('trainingProgress');
                
                if (status === 'completed') {
                    statusContent.className = 'training-status completed';
                    statusContent.innerHTML = '<div class="alert alert-success mb-0"><h6><i class="fas fa-check-circle me-2"></i>è®­ç»ƒå®Œæˆ</h6></div>';
                    const submitBtn = document.querySelector('#zeroCodeForm button[type="submit"]');
                    if (submitBtn) submitBtn.disabled = false;
                    return;
                } else if (status === 'failed') {
                    statusContent.className = 'training-status error';
                    statusContent.innerHTML = `<div class="alert alert-danger mb-0">è®­ç»ƒå¤±è´¥: ${task.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                    const submitBtn = document.querySelector('#zeroCodeForm button[type="submit"]');
                    if (submitBtn) submitBtn.disabled = false;
                    return;
                } else if (status === 'running') {
                    // æ˜¾ç¤ºè®­ç»ƒè¿›åº¦
                    const epoch = task.epoch || task.current_epoch || 0;
                    const totalEpochs = task.total_epochs || task.config?.epochs || 100;
                    const progressPercent = totalEpochs > 0 ? (epoch / totalEpochs * 100) : 0;
                    const trainLoss = task.current_train_loss || task.loss || 0;
                    const valLoss = task.current_val_loss || task.val_loss || 0;
                    
                    let progressHtml = '<div class="progress mb-2"><div class="progress-bar" role="progressbar" style="width: ' + progressPercent + '%"></div></div>';
                    progressHtml += '<div class="small text-muted">';
                    progressHtml += `Epoch: ${epoch}/${totalEpochs} | `;
                    if (trainLoss !== undefined && trainLoss !== null) {
                        progressHtml += `Train Loss: ${trainLoss.toFixed(6)} | `;
                    }
                    if (valLoss !== undefined && valLoss !== null) {
                        progressHtml += `Val Loss: ${valLoss.toFixed(6)}`;
                    }
                    progressHtml += '</div>';
                    progressContent.innerHTML = progressHtml;
                }
            } else if (result.success === false) {
                // ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²å®Œæˆ
                statusContent.className = 'training-status error';
                statusContent.innerHTML = `<div class="alert alert-warning mb-0">${result.message || 'ä»»åŠ¡çŠ¶æ€æœªçŸ¥'}</div>`;
                const submitBtn = document.querySelector('#zeroCodeForm button[type="submit"]');
                if (submitBtn) submitBtn.disabled = false;
                return;
            }
            
            attempts++;
            setTimeout(poll, 2000); // æ¯2ç§’è½®è¯¢ä¸€æ¬¡
        } catch (error) {
            console.error('æŸ¥è¯¢è®­ç»ƒçŠ¶æ€å¤±è´¥:', error);
            setTimeout(poll, 5000); // å‡ºé”™å5ç§’å†è¯•
        }
    };
    
    poll();
}
</script>
{% endblock %}

